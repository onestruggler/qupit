{-# OPTIONS  --safe #-}
{-# OPTIONS --termination-depth=2 #-}
open import Level using (0ℓ)

open import Relation.Binary using (Rel)
open import Relation.Binary.Definitions using (DecidableEquality)
open import Relation.Binary.Morphism.Definitions using (Homomorphic₂)
open import Relation.Binary.PropositionalEquality using (_≡_ ; _≢_ ; inspect ; setoid ; module ≡-Reasoning ; _≗_) renaming ([_] to [_]')
import Relation.Binary.Reasoning.Setoid as SR
import Relation.Binary.PropositionalEquality as Eq
open import Relation.Nullary.Decidable using (yes ; no)


open import Function using (_∘_ ; id)
open import Function.Definitions using (Injective)

open import Data.Product using (_×_ ; _,_ ; proj₁ ; proj₂ ; map₁ ; ∃ ; Σ ; Σ-syntax)
open import Data.Product.Relation.Binary.Pointwise.NonDependent as PW using (≡×≡⇒≡ ; Pointwise ; ≡⇒≡×≡)
open import Data.Nat hiding (_^_ ; _+_ ; _*_)
open import Agda.Builtin.Nat using (_-_)
import Data.Nat as Nat
open import Data.Bool hiding (_<_ ; _≤_)
open import Data.List hiding ([_] ; _++_ ; last ; head ; tail ; _∷ʳ_)
open import Data.Vec hiding ([_])
import Data.Vec as Vec
open import Data.Fin hiding (_+_ ; _-_)

open import Data.Maybe
open import Data.Sum using (_⊎_ ; inj₁ ; inj₂ ; [_,_] ; [_,_]′)
open import Data.Unit using (⊤ ; tt)
open import Data.Empty using (⊥ ; ⊥-elim)

open import Word.Base as WB hiding (wfoldl ; _*)
open import Word.Properties
import Presentation.Base as PB
import Presentation.Properties as PP
open PP using (NFProperty ; NFProperty')
import Presentation.CosetNF as CA
import Presentation.Reidemeister-Schreier as RS
module RSF = RS.Star-Injective-Full.Reidemeister-Schreier-Full

open import Presentation.Construct.Base hiding (_*_ ; _⊕_)
import Presentation.Construct.Properties.SemiDirectProduct2 as SDP2
import Presentation.Construct.Properties.DirectProduct as DP
import Presentation.Groups.Cyclic as Cyclic


open import Data.Fin using (Fin ; toℕ ; suc ; zero ; fromℕ)
open import Data.Fin.Properties using (suc-injective ; toℕ-inject₁ ; toℕ-fromℕ)
import Data.Nat.Properties as NP
open import Presentation.GroupLike
open import Presentation.Tactics hiding ([_] ; inspect)
open import Data.Nat.Primality



module N.Proofs.P1 (p-2 : ℕ) (p-prime : Prime (2+ p-2))  where

pattern auto = Eq.refl

pattern ₀ = zero
pattern ₁ = suc ₀
pattern ₂ = suc ₁
pattern ₃ = suc ₂
pattern ₄ = 4
pattern ₅ = 5
pattern ₆ = 6
pattern ₇ = 7
pattern ₈ = 8
pattern ₉ = 9
pattern ₁₀ = 10
pattern ₁₁ = 11
pattern ₁₂ = 12
pattern ₁₃ = 13
pattern ₁₄ = 14
pattern ₁₅ = 15

pattern ₁₊ ⱼ = suc ⱼ
pattern ₂₊ ⱼ = suc (suc ⱼ)
pattern ₃₊ ⱼ = suc (suc (suc ⱼ))


open import Zp.ModularArithmetic
open PrimeModulus p-2 p-prime
open import N.Symplectic p-2 p-prime
open import N.Lemmas-2Qupit-Sym p-2 p-prime
open import N.NF2-Sym p-2 p-prime
open Lemmas-2Q 0
open Symplectic
open Lemmas-Sym
open import N.NF1-Sym p-2 p-prime
open import N.Ex-Sym p-2 p-prime
open import N.Ex-Sym1 p-2 p-prime
open import N.Ex-Sym2 p-2 p-prime
open import N.Ex-Sym3 p-2 p-prime
open import N.Ex-Sym4 p-2 p-prime
open import N.Lemma-Comm p-2 p-prime 0 0
open import N.Duality p-2 p-prime hiding (module L0)
open import N.Lemma-Postfix p-2 p-prime
open import N.Derived p-2 p-prime
open import N.Completeness1-Sym p-2 p-prime renaming (module Completeness to Cp1)
open import N.Cosets p-2 p-prime

open Lemmas0a
open Lemmas0a1
open Lemmas0b
open Lemmas0c

open LM2
open import N.Completeness1-Sym p-2 p-prime renaming (module Completeness to CP1) using ()

open PB (2 QRel,_===_)
open PP (2 QRel,_===_)
open SR word-setoid
open Pattern-Assoc

open import Algebra.Properties.Ring (+-*-ring p-2)


open Duality
open Lemmas0 1

step-nf1-CZ : ∀ s m k -> ⟦ case-nf1 (s , m , HS^ k) ⟧₂ • CZ ≈ (M (m ⁻¹) • H ^ 2) ↑ • ⟦ case-||ₐ ₀ (s , (-' m , ε) , (m , HS^ k)) ⟧₂
step-nf1-CZ s m k = begin
  ⟦ case-nf1 (s , m , HS^ k) ⟧₂ • CZ ≈⟨ trans assoc (cong refl assoc) ⟩
  ⟦ s ⟧ₛ • ⟦ m ⟧ₘ • (H • S^ k) • CZ ≈⟨ (cright cright assoc) ⟩
  ⟦ s ⟧ₛ • ⟦ m ⟧ₘ • H • S^ k • CZ ≈⟨ (cright cright cright word-comm (toℕ k) 1 (sym (axiom comm-CZ-S↓))) ⟩
  ⟦ s ⟧ₛ • ⟦ m ⟧ₘ • H • CZ • S^ k ≈⟨ sym (cong refl assoc) ⟩
  ⟦ s ⟧ₛ • (⟦ m ⟧ₘ • H) • CZ • S^ k ≈⟨ (cright cleft sym (semi-HM' m)) ⟩
  ⟦ s ⟧ₛ • (H • ⟦ m ⁻¹ ⟧ₘ) • CZ • S^ k ≈⟨ (cright sym (trans (by-assoc auto) assoc)) ⟩
  ⟦ s ⟧ₛ • H • (⟦ m ⁻¹ ⟧ₘ • CZ) • S^ k ≈⟨ (cright cright (cleft axiom (semi-M↓CZ (m ⁻¹)))) ⟩
  ⟦ s ⟧ₛ • H • (CZ^ ((m ⁻¹) ^1) • ⟦ m ⁻¹ ⟧ₘ) • S^ k ≈⟨ (cright cright assoc) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • ⟦ m ⁻¹ ⟧ₘ • S^ k ≈⟨ (cright cright cright cright trans (sym left-unit) (sym (cong (axiom order-H) refl))) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • ⟦ m ⁻¹ ⟧ₘ • H ^ 4 • S^ k ≈⟨ (cright cright cright cright special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • ⟦ m ⁻¹ ⟧ₘ • H ^ 3 • H • S^ k ≈⟨ (cright cright cright sym assoc) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • (⟦ m ⁻¹ ⟧ₘ • H ^ 3) • H • S^ k ≈⟨ (cright cright cright (cleft sym (semi-MH³ (m ⁻¹)))) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • (H ^ 3 • ⟦ m ⁻¹ ⁻¹ ⟧ₘ) • H • S^ k ≈⟨ (cright cright cright cleft cright aux-MM ((m ⁻¹ ⁻¹) .proj₂) (m .proj₂) (inv-involutive m)) ⟩
  ⟦ s ⟧ₛ • H • CZ^ ((m ⁻¹) ^1) • (H ^ 3 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ (cright cright sym left-unit) ⟩
  ⟦ s ⟧ₛ • H • ε • CZ^ ((m ⁻¹) ^1) • (H ^ 3 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ (cright cright cleft sym (lemma-cong↑ _ _ (L0.aux-M-mulˡ m))) ⟩
  ⟦ s ⟧ₛ • H • (M (m ⁻¹) ↑ • M m ↑) • CZ^ ((m ⁻¹) ^1) • (H ^ 3 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ ( special-assoc (□ • □ • □ ^ 2 • □ • □) (□ • □ ^ 2 • □ ^ 2 • □) auto) ⟩
  ⟦ s ⟧ₛ • (H • M (m ⁻¹) ↑) • (M m ↑ • CZ^ ((m ⁻¹) ^1)) • (H ^ 3 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ (cright cong (lemma-comm-H-w↑ (M (m ⁻¹))) (cleft lemma-M↑CZ^k (m ^1) ((m ⁻¹) ^1) (m .proj₂))) ⟩
  ⟦ s ⟧ₛ • (M (m ⁻¹) ↑ • H) • (CZ^ ((m ⁻¹) ^1 * (m ^1)) • M m ↑) • (H ^ 3 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ special-assoc (□ • □ ^ 2 • □ ^ 2 • (□ ^ 3 • □) • □) (□ ^ 2 • □ • □ • □ ^ 2 • (□ ^ 2 • □) • □) auto ⟩
  (⟦ s ⟧ₛ • M (m ⁻¹) ↑) • H • CZ^ ((m ⁻¹) ^1 * (m ^1)) • (M m ↑ • H) • (H ^ 2 • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ cong (lemma-comm-Sᵏ-w↑ (toℕ s) (M (m ⁻¹))) (cright cong (refl' (Eq.cong CZ^ (lemma-⁻¹ˡ (m ^1) {{nztoℕ {y = m ^1} {neq0 = m .proj₂}}}))) (cong (sym (lemma-comm-H-w↑ (M m))) (cleft cleft refl))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • CZ • (H • M m ↑) • (HH • ⟦ m ⟧ₘ) • H • S^ k ≈⟨ (cright cright cright special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ • □) auto) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • CZ • H • (M m ↑ • HH) • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright (cright cleft sym (lemma-comm-Hᵏ-w↑ 2 (M m)))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • CZ • H • (HH • M m ↑) • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright trans (sym left-unit) (cong (sym (axiom (cong↑ order-H))) refl)) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 4 • CZ • H • (HH • M m ↑) • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright special-assoc (□ ^ 4 • □ • □ • (□ ^ 2 • □) • □) (□ ^ 2 • (□ ^ 2 • □) • □ ^ 2 • □ • □ • □) auto) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • (H ↑ ^ 2 • CZ) • HH • H • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright cleft lemma-semi-HH↑-CZ^k ₁) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • (CZ^ (- ₁) • H ↑ ^ 2) • HH • H • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright special-assoc (□ ^ 2 • □ ^ 2) (□ • □ ^ 2 • □) auto) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • CZ^ (- ₁) • (H ↑ ^ 2 • HH) • H • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright cright cleft word-comm 2 2 (axiom comm-H)) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • CZ^ (- ₁) • (HH • H ↑ ^ 2) • H • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ ((cright cright cright special-assoc (□ • □ ^ 2 • □ ^ 2)  (□ ^ 2 • □ ^ 2 • □) auto)) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • (CZ^ (- ₁) • HH) • (H ↑ ^ 2 • H) • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright cong (sym (lemma-semi-HH↓-CZ^k' ₁)) (cleft word-comm 2 1 (axiom comm-H))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • H • H ↑ ^ 2 • (HH • CZ) • (H • H ↑ ^ 2) • M m ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright special-assoc (□ • □ ^ 2 • □ ^ 2 • □ ^ 2 • □ ^ 2) (□ ^ 3 • □ ^ 3 • □ ^ 2 • □) auto) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • (H • H ↑ ^ 2) • (HH • CZ • H) • (H ↑ ^ 2 • M m ↑) • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cong (word-comm 1 2 (sym (axiom comm-H))) (cright cleft (cleft lemma-cong↑ _ _ L0.lemma-HH-M-1))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • (H ↑ ^ 2 • H) • (HH • CZ • H) • (M -'₁ ↑ • M m ↑) • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright cleft lemma-cong↑ _ _ (PB1.axiom (M-mul -'₁ m))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • (H ↑ ^ 2 • H) • (HH • CZ • H) • M (-'₁ *' m) ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cright cright cleft lemma-cong↑ _ _ (L0.aux-MM ((-'₁ *' m) .proj₂) ((-' m) .proj₂) (-1*x≈-x (m .proj₁)))) ⟩
  ( M (m ⁻¹) ↑ • ⟦ s ⟧ₛ) • (H ↑ ^ 2 • H) • (HH • CZ • H) • M (-' m) ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • (□ ^ 2 • □ ^ 2) • □ ) (□ • □ ^ 2 • (□ ^ 3 • □ ^ 2) • □) auto ⟩
  M (m ⁻¹) ↑ • (⟦ s ⟧ₛ • H ↑ ^ 2) • (H ^ 3 • CZ • H) • M (-' m) ↑ • ⟦ m ⟧ₘ • H • S^ k ≈⟨ (cright cong (word-comm (toℕ s) 2 (sym (axiom comm-S))) (cright  (cleft sym right-unit))) ⟩
  M (m ⁻¹) ↑ • (H ↑ ^ 2 • ⟦ s ⟧ₛ) • (H ^ 3 • CZ • H) • (M (-' m) ↑ • ε) • (⟦ m ⟧ₘ • H • S^ k) ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
  (M (m ⁻¹) • H ^ 2) ↑ • ⟦ s ⟧ₛ • (H ^ 3 • CZ • H) • (M (-' m) ↑ • ε) • (⟦ m ⟧ₘ • H • S^ k) ≈⟨ sym (cong refl left-unit) ⟩

  (M (m ⁻¹) • H ^ 2) ↑ • ⟦ case-||ₐ ₀ (s , (-' m , ε) , (m , HS^ k)) ⟧₂ ∎
  where
  module L0 = Lemmas0 0


step-nf1-CZ' : ∀ s m k -> ⟦ (s , m , HS^ k) ⟧₁ • CZ ≈ (M (m ⁻¹) • H ^ 2) ↑ • ⟦ case-||ₐ ₀ (s , (-' m , ε) , (m , HS^ k)) ⟧₂
step-nf1-CZ' s m k = begin
  ⟦ (s , m , HS^ k) ⟧₁ • CZ ≈⟨ cleft refl ⟩
  ⟦ case-nf1 (s , m , HS^ k) ⟧₂ • CZ ≈⟨ step-nf1-CZ s m k ⟩
  (M (m ⁻¹) • H ^ 2) ↑ • ⟦ case-||ₐ ₀ (s , (-' m , ε) , (m , HS^ k)) ⟧₂ ∎



step-|-CZ : ∀ m k s' m' ->
  let
    m⁻¹ = (m ⁻¹) .proj₁
    m'⁻¹ = (m' ⁻¹) .proj₁
    a* = m ⁻¹
    a = a* .proj₁
    l = m' .proj₁
    mf = m .proj₁
    -l : ℤ ₚ
    -l = - l
    l⁻¹ : ℤ ₚ
    l⁻¹ = ((m' ⁻¹) .proj₁)
    -l⁻¹ : ℤ ₚ
    -l⁻¹ = - l⁻¹
    s1' = - mf * m'⁻¹
    mc1' =  m , (- (m' *' m) .proj₁ + k)
    
  in
    ⟦ case-| (m , HS^ k) (s' , m' , ε) ⟧₂ • CZ ≈ ⟦ - mf * m'⁻¹ ,  m *' m' ⁻¹ , HS^ (- mf * m'⁻¹) ⟧₁ ↑ • ⟦ case-| (m , HS^ (- (m' *' m) .proj₁ + k) ) (-l * a + s' , m' , ε) ⟧₂

step-|-CZ m k s' m' = claim
  where

  module L0 = Lemmas0 0


  m⁻¹ = (m ⁻¹) .proj₁
  m'⁻¹ = (m' ⁻¹) .proj₁
  mf = m .proj₁
  a* = m ⁻¹
  a = a* .proj₁
  l = m' .proj₁
  -l : ℤ ₚ
  -l = - l
  l⁻¹ : ℤ ₚ
  l⁻¹ = ((m' ⁻¹) .proj₁)
  -l⁻¹ : ℤ ₚ
  -l⁻¹ = - l⁻¹


  s1' = - mf * m'⁻¹
  mc1' =  m , HS^ (- (m' *' m) .proj₁ + k)
  nf1' = (s1' , mc1')


  claim : ⟦ case-| (m , HS^ k) (s' , m' , ε) ⟧₂ • CZ ≈ ⟦ - mf * m'⁻¹ ,  m *' m' ⁻¹ , HS^ (- mf * m'⁻¹) ⟧₁ ↑ • ⟦ case-| (m , HS^ (- (m' *' m) .proj₁ + k) ) (-l * a + s' , m' , ε) ⟧₂
  claim  = begin
    ⟦ case-| (m , HS^ k) (s' , m' , ε) ⟧₂ • CZ ≈⟨ trans assoc (cong refl assoc) ⟩
    CZ • ⟦ (m , HS^ k) ⟧ₘ₊ ↑ • ⟦ (s' , m' , ε) ⟧₁ • CZ ≈⟨ (cright cong refl (cong (cong refl right-unit) refl)) ⟩
    CZ • (⟦ m ⟧ₘ • H • S^ k) ↑ • (S^ s' • ⟦ m' ⟧ₘ) • CZ ≈⟨ special-assoc (□ • □ ^ 3 • □ ^ 2 • □) (□ ^ 2 • □ • □ ^ 2 • □ ^ 2) auto ⟩
    (CZ • ⟦ m ⟧ₘ ↑) • H ↑ • (S^ k ↑ • S^ s') • ⟦ m' ⟧ₘ • CZ ≈⟨ cong (lemma-CZ^kM↑ (m .proj₁) ₁ (m .proj₂)) (cright (cleft sym (lemma-comm-Sᵏ-w↑ (toℕ s') (S^ k)))) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • H ↑ • (S^ s' • S^ k ↑) • ⟦ m' ⟧ₘ • CZ ≈⟨ (cright special-assoc (□ • □ ^ 2 • □ ^ 2) (□ ^ 2 • □ ^ 3) auto) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • (H ↑ • S^ s') • S^ k ↑ • ⟦ m' ⟧ₘ • CZ ≈⟨ (cright cright cright lemma-M↓CZ^k (m' .proj₁) ₁ (m' .proj₂)) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • (H ↑ • S^ s') • S^ k ↑ • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨ (cright cright sym assoc) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • (H ↑ • S^ s') • (S^ k ↑ • CZ^ (₁ * m' .proj₁)) • ⟦ m' ⟧ₘ ≈⟨ (cright cright cleft sym (aux-comm-CZ^a-S^b↑ (₁ * m' .proj₁) k)) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • (H ↑ • S^ s') • (CZ^ (₁ * m' .proj₁) • S^ k ↑) • ⟦ m' ⟧ₘ ≈⟨ (cright special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • H ↑ • (S^ s' • CZ^ (₁ * m' .proj₁)) • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cright cleft word-comm (toℕ s') (toℕ (₁ * m' .proj₁)) (sym (axiom comm-CZ-S↓))) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • H ↑ • (CZ^ (₁ * m' .proj₁) • S^ s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ special-assoc (□ ^ 2 • □ • □ ^ 2 • □ ^ 2) (□ • □ ^ 3 • □ ^ 3) auto ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ (₁ * m⁻¹) • H ↑ • CZ^ (₁ * m' .proj₁)) • S^ s' • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft cong (refl' (Eq.cong CZ^ (*-identityˡ m⁻¹))) (cright refl' (Eq.cong CZ^ (*-identityˡ ((m' .proj₁)))))) ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ m⁻¹ • H ↑ • CZ^ (m' .proj₁)) • S^ s' • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft lemma-CZ^-aHCZ^k'-dual a* m') ⟩
    ⟦ m ⟧ₘ ↑ • (S^ (-l⁻¹ * a) ↑ • H ↑ • CZ^ l • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑ • S^ (-l * a)) • S^ s' • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright special-assoc (□ ^ 7 • □ ^ 3) (□ ^ 6 • □ ^ 2 • □ ^ 2) auto ) ⟩
    ⟦ m ⟧ₘ ↑ • (S^ (-l⁻¹ * a) ↑ • H ↑ • CZ^ l • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • (S^ (-l * a) • S^ s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cong (cright cright sym left-unit) (cleft lemma-S^k+l (-l * a) s')) ⟩
    ⟦ m ⟧ₘ ↑ • (S^ (-l⁻¹ * a) ↑ • H ↑ • ε • CZ^ l • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ special-assoc (□ • □ ^ 7 • □ ^ 3) (□ ^ 3 • □ ^ 5 • □ ^ 3) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑) • (ε • CZ^ l • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft cleft sym (lemma-cong↑ _ _ (L0.aux-M-mul m') )) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑) • ((M m' ↑ • M (m' ⁻¹) ↑) • CZ^ l • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft special-assoc (□ ^ 2 • □ ^ 2) (□ • □ ^ 2 • □) auto) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑) • (M m' ↑ • (M (m' ⁻¹) ↑ • CZ^ l) • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft cright cleft lemma-M↑CZ^k l⁻¹ l ((m' ⁻¹) .proj₂)) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑) • (M m' ↑ • (CZ^ (l * l⁻¹) • M (m' ⁻¹) ↑) • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ special-assoc (□ ^ 3 • □ ^ 3 • □ ) (□ ^ 4 • □ • □ • □) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • (CZ^ (l * l⁻¹) • M (m' ⁻¹) ↑) • (H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cleft cleft refl' (Eq.cong CZ^ (lemma-⁻¹ʳ l {{nztoℕ {y = l} {neq0 = m' .proj₂}}}))) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • (CZ • M (m' ⁻¹) ↑) • (H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright assoc) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • M (m' ⁻¹) ↑ • (H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cright sym assoc) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (M (m' ⁻¹) ↑ • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • S^ (-l * a + s') • S^ k ↑ • ⟦ m' ⟧ₘ ≈⟨ (cright cright cright sym assoc) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (M (m' ⁻¹) ↑ • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • (S^ (-l * a + s') • S^ k ↑) • ⟦ m' ⟧ₘ ≈⟨ (cright cright cright cleft lemma-comm-Sᵏ-w↑ (toℕ (-l * a + s')) (S^ k)) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (M (m' ⁻¹) ↑ • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑) • (S^ k ↑ • S^ (-l * a + s')) • ⟦ m' ⟧ₘ ≈⟨ (cright cright special-assoc (□ ^ 4 • □ ^ 2 • □) (□ ^ 5 • □ ^ 2) auto) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (M (m' ⁻¹) ↑ • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑ • S^ k ↑) • S^ (-l * a + s') • ⟦ m' ⟧ₘ ≈⟨ (cright cright cright cright sym right-unit) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (M (m' ⁻¹) ↑ • H ↑ ^ 3 • S^ (l⁻¹ * a) ↑ • H ↑ • S^ k ↑) • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ (cright cright cleft lemma-cong↑ _ _ (aux-simp1 m m' k)) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • (⟦ nf1' ⟧₁ ↑) • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ refl ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • CZ • ((S^ s1' • ⟦ mc1' ⟧ₘ₊) ↑) • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ (cright special-assoc (□ • □ ^ 2 • □ ) (□ ^ 2 • □ ^ 2) auto) ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • (CZ • S^ s1' ↑) • ⟦ mc1' ⟧ₘ₊ ↑ • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ (cright cleft aux-comm-CZ^a-S^b↑ ₁ s1') ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑) • (S^ s1' ↑ • CZ) • ⟦ mc1' ⟧ₘ₊ ↑ • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ special-assoc (□ ^ 4 • □ ^ 2 • □) (□ ^ 5 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑ • S^ s1' ↑) • CZ • ⟦ mc1' ⟧ₘ₊ ↑ • S^ (-l * a + s') • ⟦ m' ⟧ₘ • ε ≈⟨ refl ⟩
    (⟦ m ⟧ₘ ↑ • S^ (-l⁻¹ * a) ↑ • H ↑ • M m' ↑ • S^ s1' ↑) • ⟦ case-| mc1' (-l * a + s' , m' , ε) ⟧₂ ≈⟨ cleft lemma-cong↑ _ _ (aux-simp2 m m' k) ⟩
    (⟦ - mf * m'⁻¹ ,  m *' m' ⁻¹ , HS^ (- mf * m'⁻¹) ⟧₁) ↑ • ⟦ case-| mc1' (-l * a + s' , m' , ε) ⟧₂ ∎



step-|-CZ' : ∀ m k' s' m' ->
  let
    m'⁻¹ = (m' ⁻¹) .proj₁
    m⁻¹ = (m ⁻¹) .proj₁
    a* = m' ⁻¹
    a = a* .proj₁
    l = m .proj₁
    -l : ℤ ₚ
    -l = - l
    l⁻¹ : ℤ ₚ
    l⁻¹ = ((m ⁻¹) .proj₁)
    -l⁻¹ : ℤ ₚ
    -l⁻¹ = - l⁻¹

    k′ : ℤ ₚ
    k′ = m'⁻¹
    a′ = m⁻¹
    m'0 = m' .proj₁
    k′⁻¹ = (((m') ⁻¹ ⁻¹) .proj₁)
    -k′⁻¹ = - k′⁻¹
    -k′ = - k′
    -m' = - m'0

  in
    ⟦ case-| (m , ε) (s' , m' , HS^ k') ⟧₂ • CZ ≈ ⟦ m  *' ((-' m') ⁻¹) ⟧ₘ ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂

step-|-CZ' m k' s' m' = claim
  where

  module L0 = Lemmas0 0

  m'⁻¹ = (m' ⁻¹) .proj₁
  m⁻¹ = (m ⁻¹) .proj₁
  a* = m' ⁻¹
  a = a* .proj₁
  l = m .proj₁
  -l : ℤ ₚ
  -l = - l
  l⁻¹ : ℤ ₚ
  l⁻¹ = ((m ⁻¹) .proj₁)
  -l⁻¹ : ℤ ₚ
  -l⁻¹ = - l⁻¹

  k′ : ℤ ₚ
  k′ = m'⁻¹
  a′ = m⁻¹
  m'0 = m' .proj₁
  k′⁻¹ = (((m') ⁻¹ ⁻¹) .proj₁)
  -k′⁻¹ = - k′⁻¹
  -k′ = - k′
  -m' = - m'0
  
  claim : ⟦ case-| (m , ε) (s' , m' , HS^ k') ⟧₂ • CZ ≈ ⟦ m  *' ((-' m') ⁻¹) ⟧ₘ ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂
  claim = begin
    ⟦ case-| (m , ε) (s' , m' , HS^ k') ⟧₂ • CZ ≈⟨ trans assoc (cong refl assoc) ⟩
    CZ • ⟦ (m , ε) ⟧ₘ₊ ↑ • ⟦ (s' , m' , HS^ k') ⟧₁ • CZ ≈⟨ cright cleft right-unit ⟩
    CZ • ⟦ m ⟧ₘ ↑ • ⟦ (s' , m' , HS^ k') ⟧₁ • CZ ≈⟨ sym assoc ⟩
    (CZ • ⟦ m ⟧ₘ ↑) • ⟦ (s' , m' , HS^ k') ⟧₁ • CZ ≈⟨ cleft lemma-CZ^kM↑ (m .proj₁) ₁ (m .proj₂) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹)) • ⟦ (s' , m' , HS^ k') ⟧₁ • CZ ≈⟨ assoc ⟩
    ⟦ m ⟧ₘ ↑ • CZ^ (₁ * m⁻¹) • ⟦ (s' , m' , HS^ k') ⟧₁ • CZ ≈⟨ cright special-assoc (□ • □ ^ 3 • □) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ (₁ * m⁻¹) •  S^ s') • ⟦ m' , HS^ k' ⟧ₘ₊ • CZ ≈⟨ cright cleft word-comm (toℕ (₁ * m⁻¹)) (toℕ s') (axiom comm-CZ-S↓) ⟩
    ⟦ m ⟧ₘ ↑ • (S^ s' • CZ^ (₁ * m⁻¹)) • ⟦ m' , HS^ k' ⟧ₘ₊ • CZ ≈⟨ cright assoc ⟩
    ⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹) • ⟦ m' , HS^ k' ⟧ₘ₊ • CZ ≈⟨ cright cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    ⟦ m ⟧ₘ ↑ • S^ s' • (CZ^ (₁ * m⁻¹) • ⟦ m' ⟧ₘ) • (H • S^ k') • CZ ≈⟨  special-assoc (□ • □ • □ ^ 2 • □ ^ 2 • □) (□ ^ 3 • □ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹)) • (⟦ m' ⟧ₘ • H) • S^ k' • CZ ≈⟨  cright cong (sym (semi-HM' m')) (word-comm (toℕ k') 1 (sym (axiom comm-CZ-S↓))) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹)) • (H • ⟦ m' ⁻¹ ⟧ₘ) • CZ • S^ k' ≈⟨  cright special-assoc (□ ^ 2 • □ ^ 2) (□ • □ ^ 2 • □) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹)) • H • (⟦ m' ⁻¹ ⟧ₘ • CZ) • S^ k' ≈⟨  cright cright cleft lemma-M↓CZ^k m'⁻¹ ₁ ((m' ⁻¹) .proj₂) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹)) • H • (CZ^ (₁ * m'⁻¹) • ⟦ m' ⁻¹ ⟧ₘ) • S^ k' ≈⟨  cright cright cleft cleft refl' (Eq.cong CZ^ (*-identityˡ m'⁻¹)) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s' • CZ^ (₁ * m⁻¹)) • H • (CZ^ m'⁻¹ • ⟦ m' ⁻¹ ⟧ₘ) • S^ k' ≈⟨  special-assoc (□ ^ 3 • □ • □ ^ 2 • □) (□ ^ 2 • □ ^ 3 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • S^ s') • (CZ^ (₁ * m⁻¹) • H • CZ^ m'⁻¹) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cleft cleft refl' (Eq.cong CZ^ (*-identityˡ m⁻¹)) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s') • (CZ^ m⁻¹ • H • CZ^ m'⁻¹) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cleft lemma-CZ^-aHCZ^k-CX (m ⁻¹) (m' ⁻¹) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s') • (S^ (-k′⁻¹ * a′) • H ^ 3 • CZ^ -k′ • H • S^ (k′⁻¹ * a′) • H • S^ (-k′ * a′) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cleft refl' (Eq.cong (\ xx -> (S^ (- xx * m⁻¹) • H ^ 3 • CZ^ (- m'⁻¹) • H • S^ ( xx * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑)) (inv-involutive m')) ⟩
    (⟦ m ⟧ₘ ↑ • S^ s') • (S^ (- m'0 * m⁻¹) • H ^ 3 • CZ^ (- m'⁻¹) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    ⟦ m ⟧ₘ ↑ • (S^ s' • S^ (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cleft lemma-S^k+l s' (- m'0 * m⁻¹) ⟩
    ⟦ m ⟧ₘ ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cleft cright sym left-unit ⟩
    ⟦ m ⟧ₘ ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • ε • CZ^ (- m'⁻¹) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cleft (cright (cleft sym (lemma-cong↑ _ _ (L0.aux-M-mulˡ (-' m'))))) ⟩
    ⟦ m ⟧ₘ ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • (M ((-' m') ⁻¹) ↑ • M (-' m') ↑) • CZ^ (- m'⁻¹) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cleft special-assoc (□ • □ ^ 2 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    ⟦ m ⟧ₘ ↑ • S^ (s' + (- m'0 * m⁻¹)) • ((H ^ 3 • M ((-' m') ⁻¹) ↑) • (M (-' m') ↑ • CZ^ (- m'⁻¹)) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cleft cong ( lemma-comm-Hᵏ-w↑ 3 (M ((-' m') ⁻¹))) (cleft lemma-M↑CZ^k ((-' m') .proj₁) (- m'⁻¹) ((-' m') .proj₂)) ⟩
    ⟦ m ⟧ₘ ↑ • S^ (s' + (- m'0 * m⁻¹)) • ((M ((-' m') ⁻¹) ↑ • H ^ 3) • (CZ^ (- m'⁻¹ * - m'0) • M (-' m') ↑) • H • S^ ( m'0 * m⁻¹) • H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  special-assoc (□ • □ • (□ ^ 2 • □ ^ 2 • □ ^ 4) • □ ^ 2) (□ • □ ^ 2 • □ ^ 2 • □ • □ • □ • □ ^ 2 • □ ^ 2 ) auto ⟩
    ⟦ m ⟧ₘ ↑ • (S^ (s' + (- m'0 * m⁻¹)) • M ((-' m') ⁻¹) ↑) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0)) • M (-' m') ↑ • H • S^ ( m'0 * m⁻¹) • (H • S^ (- m'⁻¹ * m⁻¹) ↑) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cong (lemma-comm-Sᵏ-w↑ (toℕ (s' + (- m'0 * m⁻¹))) (M ((-' m') ⁻¹))) (cright cright cright cright cleft lemma-comm-H-w↑ (S^ (- m'⁻¹ * m⁻¹))) ⟩
    ⟦ m ⟧ₘ ↑ • (M ((-' m') ⁻¹) ↑ • S^ (s' + (- m'0 * m⁻¹))) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0)) • M (-' m') ↑ • H • S^ ( m'0 * m⁻¹) • (S^ (- m'⁻¹ * m⁻¹) ↑ • H) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0)) • M (-' m') ↑ • H • S^ ( m'0 * m⁻¹) • (S^ (- m'⁻¹ * m⁻¹) ↑ • H) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cright sym assoc ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0)) • (M (-' m') ↑ • H) • S^ ( m'0 * m⁻¹) • (S^ (- m'⁻¹ * m⁻¹) ↑ • H) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cright  sym (cleft lemma-comm-H-w↑ (M (-' m'))) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0)) • (H • M (-' m') ↑) • S^ ( m'0 * m⁻¹) • (S^ (- m'⁻¹ * m⁻¹) ↑ • H) • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright special-assoc (□ ^ 2 • □ ^ 2 • □ • □ ^ 2 • □ ^ 2) (□ ^ 3 • □ • □ ^ 2 • □ ^ 3) auto ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (- m'⁻¹ * - m'0) • H) • M (-' m') ↑ • (S^ (m'0 * m⁻¹) • S^ (- m'⁻¹ * m⁻¹) ↑) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright  cong (cright cleft refl' (Eq.cong CZ^ aux)) (cright  cleft lemma-comm-Sᵏ-w↑ (toℕ (m'0 * m⁻¹)) (S^ (- m'⁻¹ * m⁻¹))) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • M (-' m') ↑ • (S^ (- m'⁻¹ * m⁻¹) ↑ • S^ ( m'0 * m⁻¹)) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright (cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • (M (-' m') ↑ • S^ (- m'⁻¹ * m⁻¹) ↑) • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cright cleft lemma-cong↑ _  _ (L0.lemma-MS^k -m' (- m'⁻¹ * m⁻¹) ((-' m') .proj₂)) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • (S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) ↑ • M (-' m') ↑) • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • ((H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) ↑) • M (-' m') ↑ • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cleft aux-comm-CX^a-S^k↑' (fromℕ< _) (fromℕ< _) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • S^ (s' + (- m'0 * m⁻¹)) • (S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) ↑ • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H)) • M (-' m') ↑ • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • (S^ (s' + (- m'0 * m⁻¹)) • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) ↑) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • M (-' m') ↑ • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cleft lemma-comm-Sᵏ-w↑ (toℕ (s' + (- m'0 * m⁻¹))) (S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ⟩
    (⟦ m ⟧ₘ ↑ • M ((-' m') ⁻¹) ↑) • (S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) ↑ • S^ (s' + (- m'0 * m⁻¹))) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • M (-' m') ↑ • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  special-assoc (□ ^ 2 • □ ^ 2 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • M (-' m') ↑ • S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨  cright cright cright  cong (sym right-unit) aux2 ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • (M (-' m') • ε) ↑ • S^ ( m'0 * m⁻¹) • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cright cright sym assoc ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • ((M (-' m') • ε) ↑ • S^ ( m'0 * m⁻¹)) • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cright cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ ( m'0 * m⁻¹)) (M (-' m') • ε)) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • (H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • (S^ ( m'0 * m⁻¹) • (M (-' m') • ε) ↑) • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • ((H ^ 3 • CZ^ (m'⁻¹ * m'0) • H) • S^ ( m'0 * m⁻¹)) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cright cleft (cleft cright cleft refl' (Eq.cong (CZ^) (lemma-⁻¹ˡ m'0 {{nztoℕ {y = m'0} {neq0 = m' .proj₂}}}))) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • ((H ^ 3 • CZ • H) • S^ ( m'0 * m⁻¹)) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cright cleft sym (lemma-CXS^k (m'0 * m⁻¹)) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ (s' + (- m'0 * m⁻¹)) • (S^ ( m'0 * m⁻¹) • S^ ( m'0 * m⁻¹) ↑ • CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • (S^ (s' + (- m'0 * m⁻¹)) • S^ ( m'0 * m⁻¹)) • (S^ ( m'0 * m⁻¹) ↑ • CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cleft lemma-S^k+l (s' + (- m'0 * m⁻¹)) (m'0 * m⁻¹) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • (S^ (s' + (- m'0 * m⁻¹) + m'0 * m⁻¹)) • (S^ ( m'0 * m⁻¹) ↑ • CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cleft aux3 ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • S^ s' • (S^ ( m'0 * m⁻¹) ↑ • CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • (S^ s' • S^ ( m'0 * m⁻¹) ↑) • (CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cleft lemma-comm-Sᵏ-w↑ (toℕ s') (S^ ( m'0 * m⁻¹)) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m'))) ↑ • (S^ ( m'0 * m⁻¹) ↑ • S^ s') • (CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  special-assoc (□ ^ 3 • □ ^ 2 • □ ^ 2) (□ ^ 4 • □ ^ 2 • □) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) • S^ ( m'0 * m⁻¹)) ↑ • (S^ s' • CZ^ (- ( m'0 * m⁻¹)) • CX) • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright special-assoc (□ ^ 3 • □) (□ ^ 2 • □ ^ 2) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) • S^ ( m'0 * m⁻¹)) ↑ • (S^ s' • CZ^ (- ( m'0 * m⁻¹))) • CX • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright cleft word-comm (toℕ s') (toℕ (- ( m'0 * m⁻¹))) (sym (axiom comm-CZ-S↓)) ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) • S^ ( m'0 * m⁻¹)) ↑ • (CZ^ (- ( m'0 * m⁻¹)) • S^ s') • CX • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cright special-assoc (□ ^ 2 • □) (□ ^ 3) auto ⟩
    (⟦ m ⟧ₘ • M ((-' m') ⁻¹)  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) • S^ ( m'0 * m⁻¹)) ↑ • CZ^ (- ( m'0 * m⁻¹)) • S^ s' • CX • (M (-' m') • ε) ↑ • ⟦ m' ⟧ₘ • H • S^ k' ≈⟨  cleft sym assoc ⟩
    ((⟦ m ⟧ₘ • M ((-' m') ⁻¹))  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m')) • S^ ( m'0 * m⁻¹)) ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂  ≈⟨  cleft cong (axiom (cong↑ (M-mul m ((-' m') ⁻¹)))) (lemma-cong↑ _ _ (L0.lemma-S^k+l ((- m'⁻¹ * m⁻¹ * (-m' * -m'))) (( m'0 * m⁻¹)))) ⟩
    (⟦ m  *' ((-' m') ⁻¹) ⟧ₘ  • S^ (- m'⁻¹ * m⁻¹ * (-m' * -m') + m'0 * m⁻¹)) ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂ ≈⟨ cleft cright aux4 ⟩
    (⟦ m  *' ((-' m') ⁻¹) ⟧ₘ  • ε) ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂  ≈⟨ cleft right-unit ⟩
    ⟦ m  *' ((-' m') ⁻¹) ⟧ₘ ↑ • ⟦ case-||ₐ (- ( m'0 * m⁻¹)) (s' , (-' m' , ε) , (m' , HS^ k')) ⟧₂ ∎
    where
    aux : - m'⁻¹ * - m'0 ≡ m'⁻¹ * m'0
    aux = Eq.trans (Eq.sym (-‿distribˡ-* m'⁻¹ (- m'0))) (Eq.trans (Eq.cong -_ (Eq.sym (-‿distribʳ-* m'⁻¹ m'0))) (-‿involutive (m'⁻¹ * m'0)))

    aux2 : S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈ S^ ( m'0 * m⁻¹) • ⟦ m' ⟧ₘ • H • S^ k'
    aux2 = begin
      S^ ( m'0 * m⁻¹) • H • ⟦ m' ⁻¹ ⟧ₘ • S^ k' ≈⟨ cright sym assoc ⟩
      S^ ( m'0 * m⁻¹) • (H • ⟦ m' ⁻¹ ⟧ₘ) • S^ k' ≈⟨ cright cleft semi-HM (m' ⁻¹) ⟩
      S^ ( m'0 * m⁻¹) • (⟦ m' ⁻¹ ⁻¹ ⟧ₘ • H) • S^ k' ≈⟨ cright cleft cleft aux-MM ((m' ⁻¹ ⁻¹) .proj₂) (m' .proj₂) (inv-involutive m') ⟩
      S^ ( m'0 * m⁻¹) • (⟦ m' ⟧ₘ • H) • S^ k' ≈⟨ cright assoc ⟩
      S^ ( m'0 * m⁻¹) • ⟦ m' ⟧ₘ • H • S^ k' ∎

    aux3 : (S^ (s' + (- m'0 * m⁻¹) + m'0 * m⁻¹)) ≈ S^ s'
    aux3 = begin
      (S^ (s' + (- m'0 * m⁻¹) + m'0 * m⁻¹)) ≈⟨ refl' (Eq.cong S^ (+-assoc s' ((- m'0 * m⁻¹)) (m'0 * m⁻¹))) ⟩
      S^ (s' + (- m'0 * m⁻¹ + m'0 * m⁻¹)) ≈⟨ refl' (Eq.cong S^ (Eq.cong (\ xx -> s' + (xx + m'0 * m⁻¹)) (Eq.sym (-‿distribˡ-* m'0  m⁻¹)))) ⟩
      S^ (s' + (- (m'0 * m⁻¹) + m'0 * m⁻¹)) ≈⟨ refl' (Eq.cong S^ (Eq.cong (s' +_) (+-inverseˡ (m'0 * m⁻¹)))) ⟩
      S^ (s' + ₀) ≈⟨ refl' (Eq.cong S^ (+-identityʳ s')) ⟩
      S^ s' ∎

    aux4-a : -m' * - m'⁻¹ ≡ ₁
    aux4-a = Eq.trans (Eq.sym (-‿distribˡ-* (m' .proj₁) (- m'⁻¹) )) (Eq.trans (Eq.cong -_ (Eq.sym (-‿distribʳ-* (m' .proj₁) (m'⁻¹) ))) (Eq.trans (-‿involutive (m'0 * m'⁻¹)) (lemma-⁻¹ʳ m'0 {{nztoℕ {y = m'0} {neq0 = m' .proj₂}}})))
    aux4 : S^ (- m'⁻¹ * m⁻¹ * (-m' * -m') + m'0 * m⁻¹) ↑ ≈ ε
    aux4 = begin
      S^ (- m'⁻¹ * m⁻¹ * (-m' * -m') + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (*-comm (- m'⁻¹ * m⁻¹) ((-m' * -m'))))) ⟩
      S^ ((-m' * -m') * (- m'⁻¹ * m⁻¹) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (*-assoc -m' -m' (- m'⁻¹ * m⁻¹)))) ⟩
      S^ (-m' * (-m' * (- m'⁻¹ * m⁻¹)) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (Eq.cong (-m' *_) (Eq.sym (*-assoc -m' (- m'⁻¹) m⁻¹))))) ⟩
      S^ (-m' * (-m' * - m'⁻¹ * m⁻¹) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (Eq.cong (-m' *_) (Eq.cong (_* m⁻¹) aux4-a)))) ⟩
      S^ (-m' * (₁ * m⁻¹) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (Eq.cong (-m' *_) (*-identityˡ m⁻¹)))) ⟩
      S^ (-m' * (m⁻¹) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (Eq.cong (_+ m'0 * m⁻¹) (Eq.sym (-‿distribˡ-* m'0 m⁻¹)))) ⟩
      S^ (- (m'0 * m⁻¹) + m'0 * m⁻¹) ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) (+-inverseˡ (m'0 * m⁻¹))) ⟩
      S^ ₀ ↑  ≈⟨ refl' (Eq.cong (\ xx -> S^ xx ↑) auto) ⟩
      ε ∎

