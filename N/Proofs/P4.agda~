{-# OPTIONS  --safe #-}
{-# OPTIONS --termination-depth=2 #-}
open import Level using (0ℓ)

open import Relation.Binary using (Rel)
open import Relation.Binary.Definitions using (DecidableEquality)
open import Relation.Binary.Morphism.Definitions using (Homomorphic₂)
open import Relation.Binary.PropositionalEquality using (_≡_ ; _≢_ ; inspect ; setoid ; module ≡-Reasoning ; _≗_) renaming ([_] to [_]')
import Relation.Binary.Reasoning.Setoid as SR
import Relation.Binary.PropositionalEquality as Eq
open import Relation.Nullary.Decidable using (yes ; no)


open import Function using (_∘_ ; id)
open import Function.Definitions using (Injective)

open import Data.Product using (_×_ ; _,_ ; proj₁ ; proj₂ ; map₁ ; ∃ ; Σ ; Σ-syntax)
open import Data.Product.Relation.Binary.Pointwise.NonDependent as PW using (≡×≡⇒≡ ; Pointwise ; ≡⇒≡×≡)
open import Data.Nat hiding (_^_ ; _+_ ; _*_)
open import Agda.Builtin.Nat using (_-_)
import Data.Nat as Nat
open import Data.Bool hiding (_<_ ; _≤_)
open import Data.List hiding ([_] ; _++_ ; last ; head ; tail ; _∷ʳ_)
open import Data.Vec hiding ([_])
import Data.Vec as Vec
open import Data.Fin hiding (_+_ ; _-_)

open import Data.Maybe
open import Data.Sum using (_⊎_ ; inj₁ ; inj₂ ; [_,_] ; [_,_]′)
open import Data.Unit using (⊤ ; tt)
open import Data.Empty using (⊥ ; ⊥-elim)

open import Word.Base as WB hiding (wfoldl ; _*)
open import Word.Properties
import Presentation.Base as PB
import Presentation.Properties as PP
open PP using (NFProperty ; NFProperty')
import Presentation.CosetNF as CA
import Presentation.Reidemeister-Schreier as RS
module RSF = RS.Star-Injective-Full.Reidemeister-Schreier-Full

open import Presentation.Construct.Base hiding (_*_ ; _⊕_)
import Presentation.Construct.Properties.SemiDirectProduct2 as SDP2
import Presentation.Construct.Properties.DirectProduct as DP
import Presentation.Groups.Cyclic as Cyclic


open import Data.Fin using (Fin ; toℕ ; suc ; zero ; fromℕ)
open import Data.Fin.Properties using (suc-injective ; toℕ-inject₁ ; toℕ-fromℕ)
import Data.Nat.Properties as NP
open import Presentation.GroupLike
open import Presentation.Tactics hiding ([_] ; inspect)
open import Data.Nat.Primality



module N.Proofs.P4 (p-2 : ℕ) (p-prime : Prime (2+ p-2))  where

pattern auto = Eq.refl

pattern ₀ = zero
pattern ₁ = suc ₀
pattern ₂ = suc ₁
pattern ₃ = suc ₂
pattern ₄ = 4
pattern ₅ = 5
pattern ₆ = 6
pattern ₇ = 7
pattern ₈ = 8
pattern ₉ = 9
pattern ₁₀ = 10
pattern ₁₁ = 11
pattern ₁₂ = 12
pattern ₁₃ = 13
pattern ₁₄ = 14
pattern ₁₅ = 15

pattern ₁₊ ⱼ = suc ⱼ
pattern ₂₊ ⱼ = suc (suc ⱼ)
pattern ₃₊ ⱼ = suc (suc (suc ⱼ))


open import Zp.ModularArithmetic
open PrimeModulus p-2 p-prime
open import N.Symplectic p-2 p-prime
open import N.Lemmas-2Qupit-Sym p-2 p-prime
open import N.NF2-Sym p-2 p-prime
open Lemmas-2Q 0
open Symplectic
open import N.NF1-Sym p-2 p-prime
open Normal-Form1
open import N.Ex-Sym p-2 p-prime
open import N.Ex-Sym1 p-2 p-prime
open import N.Ex-Sym2 p-2 p-prime
open import N.Ex-Sym3 p-2 p-prime
open import N.Ex-Sym4 p-2 p-prime
open import N.Duality p-2 p-prime
open import N.Lemma-Comm p-2 p-prime
open import N.Lemma-Postfix p-2 p-prime
open Lemmas0a
open Lemmas0a1
open Lemmas0b
open Lemmas0c

open LM2
open import N.Completeness1-Sym p-2 p-prime renaming (module Completeness to CP1) using ()

open PB (2 QRel,_===_)
open PP (2 QRel,_===_)
open SR word-setoid
open Pattern-Assoc

open import Algebra.Properties.Ring (+-*-ring p-2)
open import N.Proofs.P1

open Duality
open Lemmas0 1

lemma-MM| : ∀ m m' -> ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈ CZ^ (m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ
lemma-MM| m m' = claim
  where
  claim : ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈ CZ^ (m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ
  claim = begin
    ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈⟨  cright lemma-M↓CZ^k (m' .proj₁) ₁ (m' .proj₂) ⟩
    ⟦ m ⟧ₘ ↑ • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨  sym assoc ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m' .proj₁)) • ⟦ m' ⟧ₘ ≈⟨  cleft lemma-M↑CZ^k (m .proj₁) (₁ * m' .proj₁) (m .proj₂) ⟩
    (CZ^ (₁ * m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑) • ⟦ m' ⟧ₘ ≈⟨  cleft cleft refl' (Eq.cong CZ^ (Eq.cong (_* m .proj₁) (*-identityˡ (m' .proj₁)))) ⟩
    (CZ^ (m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑) • ⟦ m' ⟧ₘ ≈⟨ assoc ⟩
    CZ^ (m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ ∎



lemma-|MM| : ∀ m m' -> CZ • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈ ⟦ m ⟧ₘ ↑ • (CZ^ ((m ⁻¹) .proj₁ + m' .proj₁)) • ⟦ m' ⟧ₘ 
lemma-|MM| m m' = begin
    CZ • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈⟨ cright cright lemma-M↓CZ^k (m' .proj₁) ₁ (m' .proj₂) ⟩
    CZ • ⟦ m ⟧ₘ ↑ • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨ sym assoc ⟩
    (CZ • ⟦ m ⟧ₘ ↑) • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨ cleft lemma-CZ^kM↑ (m .proj₁) ₁ (m .proj₂) ⟩
    (⟦ m ⟧ₘ ↑ • CZ^ (₁ * (m ⁻¹) .proj₁)) • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 ) (□ • □ ^ 2 • □) auto ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ (₁ * (m ⁻¹) .proj₁) • CZ^ (₁ * m' .proj₁)) • ⟦ m' ⟧ₘ ≈⟨ cright cleft (cong (refl' (Eq.cong CZ^ (*-identityˡ ((m ⁻¹) .proj₁)))) (refl' (Eq.cong CZ^ (*-identityˡ (m' .proj₁))))) ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ ((m ⁻¹) .proj₁) • CZ^ (m' .proj₁)) • ⟦ m' ⟧ₘ ≈⟨ cright cleft lemma-CZ^k+l ((m ⁻¹) .proj₁) ((m') .proj₁) ⟩
    ⟦ m ⟧ₘ ↑ • (CZ^ ((m ⁻¹) .proj₁ + m' .proj₁)) • ⟦ m' ⟧ₘ ∎


open Sym0-Rewriting 1
open Commuting-Symplectic 0

{-


aux-NF2'''-aux : ∀ k* l (pf : Postfix) ->
  let
  (sp , mc2 , mc1) = pf
  pf' = (sp + l , mc1 , mc2)
  kp = prede k*  
  in
  ⟦ case-|| k* l pf ⟧₂ ≈ CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • S^ l • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑ • Ex
aux-NF2'''-aux k*@(k , nzk) l pf@(sp , mc2 , mc1) = begin
  ⟦ case-|| k* l pf ⟧₂ ≈⟨ refl ⟩
  CZ^ k • H^ ₃ ↑ • S^ l ↑ • ⟦ pf ⟧ₚ ≈⟨ cleft lemma-CZ^-pred k* ⟩
  (CZ^ kp • CZ) • H^ ₃ ↑ • S^ l ↑ • ⟦ pf ⟧ₚ ≈⟨ assoc ⟩
  CZ^ kp • CZ • H^ ₃ ↑ • S^ l ↑ • S^ sp • (H^ ₃ • CZ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright cright sym assoc ⟩
  CZ^ kp • CZ • H^ ₃ ↑ • (S^ l ↑ • S^ sp) • (H^ ₃ • CZ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright cright sym (cleft lemma-comm-Sᵏ-w↑ (toℕ sp) (S^ l)) ⟩
  CZ^ kp • CZ • H^ ₃ ↑ • (S^ sp • S^ l ↑) • (H^ ₃ • CZ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright special-assoc (□ • □ ^ 2 • □ ^ 3 • □) (□ ^ 2 • □ ^ 2 • □ ^ 2 • □) auto ⟩
  CZ^ kp • CZ • (H^ ₃ ↑ • S^ sp) • (S^ l ↑ • H^ ₃) • (CZ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright cong (sym (lemma-comm-Sᵏ-w↑ (toℕ sp) (H ^ 3))) (cong (sym (lemma-comm-Hᵏ-w↑ 3 (S^ l))) refl) ⟩
  CZ^ kp • CZ • (S^ sp • H^ ₃ ↑) • (H^ ₃ • S^ l ↑) • (CZ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright special-assoc (□ • □ ^ 2 • □ ^ 2 • □ ^ 2 • □) (□ ^ 2 • □ • □ • □ ^ 2 • □ ^ 2) auto ⟩
  CZ^ kp • (CZ • S^ sp) • H^ ₃ ↑ • H^ ₃ • (S^ l ↑ • CZ) • H • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cong (word-comm 1 (toℕ sp) (axiom comm-CZ-S↓)) (cright cright cleft sym (aux-comm-CZ^a-S^b↑ ₁ l)) ⟩
  CZ^ kp • (S^ sp • CZ) • H^ ₃ ↑ • H^ ₃ • (CZ • S^ l ↑) • H • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright special-assoc (□ ^ 2 • □ • □ • □ ^ 2 • □ ^ 3) (□ • □ ^ 4 • □ ^ 2 • □ ^ 2) auto ⟩
  CZ^ kp • S^ sp • (CZ • H^ ₃ ↑ • H^ ₃ • CZ) • (S^ l ↑ • H) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright cright cleft sym (lemma-comm-H-w↑ (S^ l)) ⟩
  CZ^ kp • S^ sp • (CZ • H^ ₃ ↑ • H^ ₃ • CZ) • (H • S^ l ↑) • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright special-assoc (□ ^ 4 • □ ^ 2 • □) (□ ^ 5 • □ ^ 2) auto ⟩
  CZ^ kp • S^ sp • (CZ • H^ ₃ ↑ • H^ ₃ • CZ • H) • S^ l ↑ • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ cright cright cleft aux-hEx ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H • Ex ) • S^ l ↑ • ⟦ mc2 ⟧ₘ₊ ↑ • ⟦ mc1 ⟧ₘ₊ ≈⟨ sym (cright cright cright cong (lemma-Ex-dual' (wmap _↥ (S ^ toℕ l))) (cong (lemma-Ex-dual' (⟦ mc2 ⟧ₘ₊ ↑)) (lemma-Ex-dual' ⟦ mc1 ⟧ₘ₊))) ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H • Ex ) • (Ex • dual (S^ l ↑) • Ex) • (Ex • dual (⟦ mc2 ⟧ₘ₊ ↑) • Ex) • Ex • dual ⟦ mc1 ⟧ₘ₊ • Ex ≈⟨ special-assoc (□ • □ • □ ^ 5 • □ ^ 3 • □ ^ 3 • □ ^ 3) (□ • □ • □ ^ 4 • □ ^ 2 • □ • □ ^ 2 • □ • □ ^ 2 • □ ^ 2) auto ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • Ex ^ 2 • dual (S^ l ↑) • Ex ^ 2 • dual (⟦ mc2 ⟧ₘ₊ ↑) • Ex ^ 2 • dual ⟦ mc1 ⟧ₘ₊ • Ex ≈⟨ cright cright cright cong lemma-order-Ex (cright cong lemma-order-Ex (cright (cleft lemma-order-Ex))) ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • ε • dual (S^ l ↑) • ε • dual (⟦ mc2 ⟧ₘ₊ ↑) • ε • dual ⟦ mc1 ⟧ₘ₊ • Ex ≈⟨ by-assoc auto ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • dual (S^ l ↑) • dual (⟦ mc2 ⟧ₘ₊ ↑) • dual ⟦ mc1 ⟧ₘ₊ • Ex ≈⟨ cright cright cright cong (refl' (aux-dual-S^k↑ (toℕ l))) (cong (refl' (aux-dual-MC↑ mc2)) (cleft refl' (aux-dual-MC mc1))) ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • S^ l • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑ • Ex ∎
  where
  kp = prede k*


aux-NF2'''0b : ∀ k* (pf : Postfix) -> (nz : prede k* ≢ ₀) ->
  let
  (sp , mc2 , mc1) = pf
  pf' = (sp , mc1 , mc2)
  kp = prede k*
  aux : - kp ≢ ₀
  aux = (-' (kp , nz)) .proj₂
  in
  ⟦ case-|| k* ₀ pf ⟧₂ ≈ HH ↑ • (⟦ case-|| (- kp , aux)  ₀  (sp , mc1 , mc2)⟧₂) • Ex

aux-NF2'''0b k*@(k , nzk) pf@(sp , mc2 , mc1) nz = begin
  ⟦ case-|| k* ₀ pf ⟧₂ ≈⟨ aux-NF2'''-aux k* ₀ pf ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • S^ ₀ • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑ • Ex ≈⟨ cright cright cright left-unit ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑ • Ex ≈⟨ cright special-assoc (□ • □ ^ 2 • □ ^ 3) (□ ^ 2 • □ ^ 3 • □) auto ⟩
  CZ^ kp • (S^ sp • H ↑) • ((H ^ 3 • CZ • H) • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft lemma-comm-Sᵏ-w↑ (toℕ sp) H ⟩
  CZ^ kp • (H ↑ • S^ sp) • ((H ^ 3 • CZ • H) • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright assoc ⟩
  CZ^ kp • H ↑ • S^ sp • ((H ^ 3 • CZ • H) • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft cright aux-comm-MCMC (mc2 .proj₁) (mc2 .proj₂) (mc1 .proj₁) (mc1 .proj₂) ⟩
  CZ^ kp • H ↑ • S^ sp • ((H ^ 3 • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc2 ⟧ₘ₊) • Ex ≈⟨ cright sym (cong refl assoc) ⟩
  CZ^ kp • H ↑ • (S^ sp • ((H ^ 3 • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc2 ⟧ₘ₊)) • Ex ≈⟨ refl ⟩
  CZ^ kp • H ↑ • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ trans (sym left-unit) (sym (cong (axiom (cong↑ order-H)) refl)) ⟩
  H ↑ ^ 4 • CZ^ kp • H ↑ • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ special-assoc (□ ^ 4 • □ ^ 2 ) (□ ^ 2 • (□ ^ 2 • □) • □) auto ⟩
  HH ↑ • (HH ↑ • CZ^ kp) • H ↑ • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ cright cleft lemma-semi-HH↑-CZ^k' kp ⟩
  HH ↑ • (CZ^ (- kp) • HH ↑) • H ↑ • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ cright special-assoc (□ ^ 3 • □ ^ 2) (□ • □ ^ 3 • □) auto ⟩
  HH ↑ • CZ^ (- kp) • H ↑ ^ 3 • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ cright cright cright trans (sym left-unit) refl ⟩
  HH ↑ • CZ^ (- kp) • H ↑ ^ 3 • S^ ₀ • ⟦ sp , mc1 , mc2 ⟧ₚ • Ex ≈⟨ cright special-assoc (□ ^ 5) (□ ^ 4 • □) auto ⟩
  HH ↑ • (CZ^ (- kp) • H ↑ ^ 3 • S^ ₀ • ⟦ sp , mc1 , mc2 ⟧ₚ) • Ex ≈⟨ refl ⟩
  HH ↑ • (⟦ case-|| (- kp , aux)  ₀  (sp , mc1 , mc2)⟧₂) • Ex ∎
  where
  kp = prede k*
  aux : - kp ≢ ₀
  aux = (-' (kp , nz)) .proj₂
  


aux-NF2''' : ∀ k* l (pf : Postfix) -> (nz : l ≢ ₀) ->
  let
  (sp , mc2 , mc1) = pf
  pf' = (sp + l , mc1 , mc2)
  w = H • S^ l
  in
  ⟦ case-|| k* l pf ⟧₂ ≈ CZ^ (prede k*) • w ↑ • ⟦ case-||ₐ (- l) pf' ⟧₂
aux-NF2''' k*@(k , nzk) l pf@(sp , mc2 , mc1) nz = begin
  ⟦ case-|| k* l pf ⟧₂ ≈⟨ refl ⟩
  CZ^ k • H^ ₃ ↑ • S^ l ↑ • ⟦ pf ⟧ₚ ≈⟨ aux-NF2'''-aux k* l pf ⟩
  CZ^ kp • S^ sp • (H ↑ • H ^ 3 • CZ • H) • S^ l • ⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑ • Ex ≈⟨ cright cright cong (general-comm auto ) (cright sym assoc) ⟩
  
  CZ^ kp • S^ sp • (HH • H ↑ • H • CZ • H) • S^ l • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cleft general-comm auto ⟩
  CZ^ kp • S^ sp • (HH • ε • H ↑ • H • CZ • H) • S^ l • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cleft (cright cleft sym aux) ⟩
  CZ^ kp • S^ sp • (HH • (CZ ^ p-1 • H ↑ ^ 3 •  H ↑ • CZ) • H ↑ • H • CZ • H) • S^ l • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ special-assoc (□ • □ • (□ • □ ^ 4 • □ ^ 4) • □ ^ 2) (□ ^ 5 • (□ ^ 6 • □) • □) auto ⟩
  (CZ^ kp • S^ sp • HH • CZ ^ p-1 • H ↑ ^ 3) • ((H ↑ • CZ • H ↑ • H • CZ • H) • S^ l) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft lemma-Induction (sym lemma-comm-S↑-Ex'') (toℕ l) ⟩
  (CZ^ kp • S^ sp • HH • CZ ^ p-1 • H ↑ ^ 3) • (S ↑ ^ toℕ l • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft cleft refl' (aux-↑ S (toℕ l)) ⟩
  (CZ^ kp • S^ sp • HH • CZ ^ p-1 • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cright cright cright cleft refl' (Eq.cong (CZ ^_) (Eq.sym lemma-toℕ-ₚ₋₁)) ⟩
  (CZ^ kp • S^ sp • HH • CZ^ ₋₁ • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft (cright cright sym assoc) ⟩
  (CZ^ kp • S^ sp • (HH • CZ^ ₋₁) • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cright cright cleft sym lemma-semi-CZ-HH↓ ⟩
  (CZ^ kp • S^ sp • (CZ • HH) • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft (cright special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ ^ 2) auto) ⟩
  (CZ^ kp • (S^ sp • CZ) • HH • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cright cleft word-comm (toℕ sp) 1 (sym (axiom comm-CZ-S↓)) ⟩
  (CZ^ kp • (CZ • S^ sp) • HH • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft special-assoc (□ • □ ^ 2 • □ ^ 2) (□ ^ 2 • □ ^ 3) auto ⟩
  ((CZ^ kp • CZ) • S^ sp • HH • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cleft sym (lemma-CZ^-pred (k , nzk)) ⟩
  ((CZ^ k) • S^ sp • HH • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft special-assoc □ □ auto ⟩
  
  (CZ^ k • S^ sp • HH • H ↑ ^ 3) • (S^ l ↑ • (H ↑ • CZ • H ↑ • H • CZ • H)) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ special-assoc (□ ^ 4 • (□ • □ ^ 6) • □) (□ ^ 3 • □ ^ 3 • □ ^ 5 • □) auto ⟩
  (CZ^ k • S^ sp • HH) • (H ↑ ^ 3 • S^ l ↑ • H ↑) • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft lemma-cong↑ _ _ (lemma-Euler-Mˡ' l*) ⟩
  (CZ^ k • S^ sp • HH) • (M (l* ⁻¹) • S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft sym assoc ⟩
  ((CZ^ k • S^ sp) • HH) • (M (l* ⁻¹) • S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cleft word-comm (toℕ k) (toℕ sp) (axiom comm-CZ-S↓) ⟩
  ((S^ sp • CZ^ k) • HH) • (M (l* ⁻¹) • S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft assoc ⟩
  (S^ sp • CZ^ k • HH) • (M (l* ⁻¹) • S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cleft cright lemma-semi-CZ^k-HH↓ k ⟩
  (S^ sp • HH • CZ^ (- k)) • (M (l* ⁻¹) • S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ special-assoc (□ ^ 3 • □ ^ 4 • □) (□ ^ 2 • □ ^ 2 • □ ^ 3 • □) auto ⟩
  (S^ sp • HH) • (CZ^ (- k) • M (l* ⁻¹) ↑) • (S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft lemma-CZ^kM↑ l⁻¹ (- k) ((l* ⁻¹) .proj₂)  ⟩
  (S^ sp • HH) • (M (l* ⁻¹) ↑ • CZ^ (-k * l⁻¹⁻¹)) • (S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cleft cright refl' (Eq.cong CZ^ (Eq.cong (-k *_) (inv-involutive l*))) ⟩
  (S^ sp • HH) • (M (l* ⁻¹) ↑ • CZ^ (-k * l)) • (S^ -l • H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright special-assoc (□ ^ 2 • □ ^ 3 • □) (□ • □ ^ 2 • □ ^ 2 • □) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • (CZ^ (-k * l) • S^ -l ↑) • (H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cleft aux-comm-CZ^a-S^b↑ (-k * l) -l ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • (S^ -l ↑ • CZ^ (-k * l)) • (H • S^ -l⁻¹) ↑ • (CZ • H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright special-assoc (□ ^ 2 • □ ^ 5 • □) (□ • □ ^ 2 • □ ^ 4 • □) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • (S^ -l ↑ • CZ^ (-k * l)) • H ↑ • (S^ -l⁻¹ ↑ • CZ) • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cright cleft sym (aux-comm-CZ^a-S^b↑ ₁ -l⁻¹) ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • (S^ -l ↑ • CZ^ (-k * l)) • H ↑ • (CZ • S^ -l⁻¹ ↑) • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright special-assoc (□ ^ 2 • □ • □ ^ 2 • □) (□ • □ ^ 3 • □ • □) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • (CZ^ (-k * l) • H ↑ • CZ) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft lemma-CZ^-aHCZ^k'-dual (-' k* *' l*) (₁ , (λ ())) ⟩
  
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • (S^ (-1⁻¹ * -kl) ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ (1⁻¹ * -kl) ↑ • H ↑ • S^ (- ₁ * -kl) ) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft cong (refl' (Eq.cong (\ xx -> S^ xx ↑) aux1)) (cright cright cright cong (refl' (Eq.cong (\ xx -> S^ xx ↑) aux2)) (cright refl' (Eq.cong S^ (-1*x≈-x -kl)))) ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • (S^ (- -kl) ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑ • S^ (- -kl)) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft cong (refl' (Eq.cong (\ xx -> S^ xx ↑) aux3)) (cright cright (cright cright (cright refl' (Eq.cong S^ aux3)))) ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑ • S^ kl) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft special-assoc (□ ^ 7) (□ ^ 6 • □) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • ((S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑) • S^ kl) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cleft sym (sym aux4) ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • (S^ kl • (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑)) • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright special-assoc (((□ • □ ^ 6) • □)) (□ ^ 8) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑ • S^ -l⁻¹ ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cright cright cright cright special-assoc (□ • □ • □ • □ • (□ ^ 4) • □ ) (□ ^ 5 • □ ^ 4) auto ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • CZ • (H ^ 3 • S^ -kl • H • S^ -l⁻¹ • H) ↑ • H • CZ • H • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ cright cright cright cright cright cright cright cleft  lemma-cong↑  _ _ (nf1p .proj₂) ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • CZ • ⟦ nf₁ ⟧₁ ↑ • H • CZ • H • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ {!!} ⟩


  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • CZ • H ↑ ^ 2 • S^ -l ↑ • (S^ -l⁻¹ ↑ •  H ↑ • S^ -kl ↑ • H ↑ • S^ -l⁻¹ ↑) • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ {!!} ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • CZ • H ↑ ^ 2 • S^ -l ↑ • M (-' l* ⁻¹) ↑ • (H ↑ • H • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ {!!} ⟩
  (S^ sp • HH) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl • S^ kl ↑ • H ↑ • S^ -l ↑ • M (-' l* ⁻¹) ↑ • (CZ^ -l • H ↑ ^ 2 • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ {!!} ⟩
  (S^ sp) • M (l* ⁻¹) ↑ • S^ -l ↑ • S^ kl ↑ • H ↑ • S^ -l ↑ • M (-' l* ⁻¹) ↑ • (CZ^ -l • H ↑ ^ 3 • S^ kl • H ^ 3 • CZ • H) • (⟦ mc2 ⟧ₘ₊ • ⟦ mc1 ⟧ₘ₊ ↑) • Ex ≈⟨ {!!} ⟩
  
  CZ^ (prede k*) • w ↑ • ⟦ case-||ₐ (- l) pf' ⟧₂ ∎
  where
  1⁻¹ : ℤ ₚ
  1⁻¹ = (((₁ , {!!}) ⁻¹)) .proj₁
  
  pf' = (sp + l , mc1 , mc2)
  w : Word (Gen 1)
  w = H • S^ l
  kp = prede k*
  l* = (l , nz)
  -l = - l
  l⁻¹ = ((l* ⁻¹) .proj₁)
  l⁻¹⁻¹ = ((l* ⁻¹ ⁻¹) .proj₁)
  -l⁻¹ = -((l* ⁻¹) .proj₁)
  -k = - k
  -kl = -k * l
  kl = k * l
  aux : CZ ^ p-1 • H ↑ ^ 3 •  H ↑ • CZ ≈ ε
  aux = begin
    CZ ^ p-1 • H ↑ ^ 3 •  H ↑ • CZ ≈⟨ cright sym assoc ⟩
    CZ ^ p-1 • (H ↑ ^ 3 •  H ↑) • CZ ≈⟨ cright cleft rewrite-sym0 100 auto ⟩
    CZ ^ p-1 • ε • CZ ≈⟨ cright left-unit ⟩
    CZ ^ p-1 • CZ ≈⟨ word-comm p-1 1 refl ⟩
    CZ ^ p ≈⟨ axiom order-CZ ⟩
    ε ∎
  aux1 : -1⁻¹ * -kl ≡ - -kl
  aux1 = Eq.trans (Eq.cong (_* -kl) inv-neg₁ ) (-1*x≈-x -kl)
  aux2 : 1⁻¹ * -kl ≡ -kl
  aux2 = Eq.trans (Eq.cong (_* -kl) aux₁⁻¹') (*-identityˡ -kl)
  aux3 : - -kl ≡ kl
  aux3 = Eq.trans (Eq.cong -_ (Eq.sym (-‿distribˡ-* k l))) (-‿involutive kl)
  aux4 : (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑) • S^ kl ≈ S^ kl • (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑)
  aux4 = begin
    (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑) • S^ kl ≈⟨ special-assoc (□ ^ 6 • □) (□ ^ 3 • □ ^ 3 • □) auto ⟩
    (S^ kl ↑ • H ↑ • CZ) • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) • S^ kl ≈⟨ cright sym (lemma-comm-Sᵏ-w↑ (toℕ kl) (H ^ 3 • S^ -kl • H)) ⟩
    (S^ kl ↑ • H ↑ • CZ) • S^ kl • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) ≈⟨ special-assoc (□ ^ 3 • □ • □ ^ 3) (□ ^ 2 • □ ^ 2 • □ ^ 3) auto ⟩
    (S^ kl ↑ • H ↑) • (CZ • S^ kl) • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) ≈⟨ cright cleft word-comm 1 (toℕ kl) (axiom comm-CZ-S↓) ⟩
    (S^ kl ↑ • H ↑) • (S^ kl • CZ) • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □ ^ 3) ((□ ^ 2 • □) • □ • □ ^ 3) auto ⟩
    ((S^ kl ↑ • H ↑) • S^ kl) • CZ • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) ≈⟨ cleft sym (lemma-comm-Sᵏ-w↑ (toℕ kl) (S^ kl • H)) ⟩
    (S^ kl • (S^ kl ↑ • H ↑)) • CZ • (H ↑ ^ 3 • S^ -kl ↑ • H ↑) ≈⟨ special-assoc (□ ^ 3 • □ • □ ^ 3) (□ • □ ^ 6) auto ⟩
    S^ kl • (S^ kl ↑ • H ↑ • CZ • H ↑ ^ 3 • S^ -kl ↑ • H ↑) ∎


  open CP1
  tw : TopwWord {0} (H ^ 3 • S^ -kl • H • S^ -l⁻¹ • H)
  tw = (tt , tt , tt) , top-S^k (toℕ -kl) , tt , top-S^k (toℕ -l⁻¹) , tt
  nf1p = CP1.Theorem-single-qupit-completeness (H ^ 3 • S^ -kl • H • S^ -l⁻¹ • H) tw
  nf₁ = nf1p .proj₁
  s₁ = nf₁ .proj₁
  mc₁ = nf₁ .proj₂


{-



lemma-|MCMC| : ∀ mc mc' -> ∃ \ w -> CZ • ⟦ mc ⟧ₘ₊ ↑ • ⟦ mc' ⟧ₘ₊ • CZ ≈ w
lemma-|MCMC| mc@(m , c@ε) mc'@(m' , c'@ε) = w , claim
  where
  w : {!!}
  w = {!!}
  claim : CZ • ⟦ mc ⟧ₘ₊ ↑ • ⟦ mc' ⟧ₘ₊ • CZ ≈ w
  claim = begin
    CZ • ⟦ mc ⟧ₘ₊ ↑ • ⟦ mc' ⟧ₘ₊ • CZ ≈⟨ cright cong right-unit (cong right-unit refl) ⟩
    CZ • ⟦ m ⟧ₘ ↑ • ⟦ m' ⟧ₘ • CZ ≈⟨ cright cright lemma-M↓CZ^k (m' .proj₁) ₁ (m' .proj₂) ⟩
    CZ • ⟦ m ⟧ₘ ↑ • CZ^ (₁ * m' .proj₁) • ⟦ m' ⟧ₘ ≈⟨ cright sym assoc ⟩
    CZ • (⟦ m ⟧ₘ ↑ • CZ^ (₁ * m' .proj₁)) • ⟦ m' ⟧ₘ ≈⟨ cright cleft lemma-M↑CZ^k (m .proj₁) (₁ * m' .proj₁) (m .proj₂) ⟩
    CZ • (CZ^ (₁ * m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑) • ⟦ m' ⟧ₘ ≈⟨ cright cleft cleft refl' (Eq.cong CZ^ (Eq.cong (_* m .proj₁) (*-identityˡ (m' .proj₁)))) ⟩
    CZ • (CZ^ (m' .proj₁ * m .proj₁) • ⟦ m ⟧ₘ ↑) • ⟦ m' ⟧ₘ ≈⟨ {!!} ⟩
    w ∎

lemma-|MCMC| mc@(m , c@ε) mc'@(m' , c'@(HS^ k)) = {!!}
lemma-|MCMC| mc@(m , c@(HS^ k)) mc'@(m' , c'@ε) = {!!}
lemma-|MCMC| mc@(m , c@(HS^ k)) mc'@(m' , c'@(HS^ k')) = {!!}
-}
-}
