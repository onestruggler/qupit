{-# OPTIONS  --safe #-}
{-# OPTIONS --termination-depth=2 #-}
{-# OPTIONS  --call-by-name #-}

open import Level using (0ℓ)

open import Relation.Binary using (Rel)
open import Relation.Binary.Definitions using (DecidableEquality)
open import Relation.Binary.Morphism.Definitions using (Homomorphic₂)
open import Relation.Binary.PropositionalEquality using (_≡_ ; _≢_ ; inspect ; setoid ; module ≡-Reasoning ; _≗_) renaming ([_] to [_]')
import Relation.Binary.Reasoning.Setoid as SR
import Relation.Binary.PropositionalEquality as Eq
open import Relation.Nullary.Decidable using (yes ; no)


open import Function using (_∘_ ; id)
open import Function.Definitions using (Injective)

open import Data.Product using (_×_ ; _,_ ; proj₁ ; proj₂ ; map₁ ; ∃ ; Σ ; Σ-syntax)
open import Data.Product.Relation.Binary.Pointwise.NonDependent as PW using (≡×≡⇒≡ ; Pointwise ; ≡⇒≡×≡)
open import Data.Nat hiding (_^_ ; _+_ ; _*_)
open import Agda.Builtin.Nat using (_-_)
import Data.Nat as Nat
open import Data.Bool hiding (_<_ ; _≤_)
open import Data.List hiding ([_] ; _++_ ; last ; head ; tail ; _∷ʳ_)
open import Data.Vec hiding ([_])
import Data.Vec as Vec
open import Data.Fin hiding (_+_ ; _-_)

open import Data.Maybe
open import Data.Sum using (_⊎_ ; inj₁ ; inj₂ ; [_,_] ; [_,_]′)
open import Data.Unit using (⊤ ; tt)
open import Data.Empty using (⊥ ; ⊥-elim)

open import Word.Base as WB hiding (wfoldl ; _*)
open import Word.Properties
import Presentation.Base as PB
import Presentation.Properties as PP
open PP using (NFProperty ; NFProperty')
import Presentation.CosetNF as CA
import Presentation.Reidemeister-Schreier as RS
module RSF = RS.Star-Injective-Full.Reidemeister-Schreier-Full

open import Presentation.Construct.Base hiding (_*_ ; _⊕_)
import Presentation.Construct.Properties.SemiDirectProduct2 as SDP2
import Presentation.Construct.Properties.DirectProduct as DP
import Presentation.Groups.Cyclic as Cyclic


open import Data.Fin using (Fin ; toℕ ; suc ; zero ; fromℕ)
open import Data.Fin.Properties using (suc-injective ; toℕ-inject₁ ; toℕ-fromℕ)
import Data.Nat.Properties as NP
open import Presentation.GroupLike
open import Presentation.Tactics hiding ([_] ; inspect)
open import Data.Nat.Primality



module N.Lemma-Postfix (p-2 : ℕ) (p-prime : Prime (2+ p-2))  where

pattern auto = Eq.refl

pattern ₀ = zero
pattern ₁ = suc ₀
pattern ₂ = suc ₁
pattern ₃ = suc ₂
pattern ₄ = 4
pattern ₅ = 5
pattern ₆ = 6
pattern ₇ = 7
pattern ₈ = 8
pattern ₉ = 9
pattern ₁₀ = 10
pattern ₁₁ = 11
pattern ₁₂ = 12
pattern ₁₃ = 13
pattern ₁₄ = 14
pattern ₁₅ = 15

pattern ₁₊ ⱼ = suc ⱼ
pattern ₂₊ ⱼ = suc (suc ⱼ)
pattern ₃₊ ⱼ = suc (suc (suc ⱼ))


open import Zp.ModularArithmetic
open PrimeModulus p-2 p-prime
open import N.Symplectic p-2 p-prime
open import N.Lemmas-2Qupit p-2 p-prime
open import N.NF2-Sym p-2 p-prime
open Lemmas-2Q 2
open Symplectic
open Lemmas-Sym
open import N.NF1-Sym p-2 p-prime
open import N.Ex-Sym p-2 p-prime
open import N.Ex-Sym2 p-2 p-prime
open import N.Cosets p-2 p-prime
open import N.Lemma-Comm p-2 p-prime 0
open Lemmas0a
open Lemmas0b
open Lemmas0 1

open LM2
open import N.Completeness1-Sym p-2 p-prime renaming (module Completeness to CP1) using ()

open PB (2 QRel,_===_)
open PP (2 QRel,_===_)
module PB1 = PB (1 QRel,_===_)
module PP1 = PP (1 QRel,_===_)

open SR word-setoid
open Pattern-Assoc
open Duality


SingleQGen : Gen 2 -> Set
SingleQGen (H-gen) = ⊤
SingleQGen (S-gen) = ⊤
SingleQGen (H-gen ↥) = ⊤
SingleQGen (S-gen ↥) = ⊤
SingleQGen (CZ-gen) = ⊥



Lemma-Postfix-SingleQ :

  ∀ (pf : Postfix) (g : Gen 2) -> (SingleQGen g) ->
  ---------------------------------------------------------
  ∃ \ cz -> ∃ \ s -> ∃ \ pf' -> ⟦ pf ⟧ₚ • [ g ]ʷ ≈ CZ^ cz • S^ s ↑ • ⟦ pf' ⟧ₚ

Lemma-Postfix-SingleQ pf@(k , mc1 , mc0) H-gen sg = cz , s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-H {1} mc0
  k0 = t0 .proj₁
  mc0' = t0 .proj₂ .proj₁
  cz : ℤ ₚ
  cz = - k0
  s : ℤ ₚ
  s = k0
  k' = k + k0
  pf' = k' , mc1 , mc0'
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ≈ CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ≈⟨ (cright t0 .proj₂ .proj₂) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S^ k0 • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S^ k0) • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ k0) ⟦ mc1 ⟧ₘ₊)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-CXS^k k0)) ⟩
    S^ k • (S^ k0 • S^ k0 ↑ • CZ^ (- k0) • H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 4 • □) (□ ^ 2 • □ ^ 4) auto ⟩
    (S^ k • S^ k0) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-S^k+l k k0) ⟩
    (S^ (k + k0)) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ sym assoc ⟩
    (S^ (k + k0) • S^ k0 ↑) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ (k + k0)) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ (k + k0)) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    S^ k0 ↑ • S^ (k + k0) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright sym assoc) ⟩
    S^ k0 ↑ • (S^ (k + k0) • CZ^ (- k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft word-comm (toℕ (k + k0)) (toℕ (- k0)) (sym (axiom comm-CZ-S↓))) ⟩
    S^ k0 ↑ • (CZ^ (- k0) • S^ (k + k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k0 ↑ • CZ^ (- k0)) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft sym (aux (- k0) k0)) ⟩
    (CZ^ (- k0) • S^ k0 ↑) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ ∎
    where
    aux : ∀ a b -> CZ^ a • S^ b ↑ ≈ S^ b ↑ • CZ^ a
    aux a b = begin
      CZ^ a • S^ b ↑ ≈⟨ (cright sym (refl' (aux-↑ S (toℕ b)))) ⟩
      CZ^ a • S ↑ ^ toℕ b ≈⟨ word-comm (toℕ a) (toℕ b) (axiom comm-CZ-S↑) ⟩
      S ↑ ^ toℕ b • CZ^ a ≈⟨ (cleft refl' (aux-↑ S (toℕ b))) ⟩
      S^ b ↑ • CZ^ a ∎

Lemma-Postfix-SingleQ pf@(k , mc1 , mc0) S-gen sg = cz , s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-S {1} mc0
  k0 = t0 .proj₁
  mc0' = t0 .proj₂ .proj₁
  cz : ℤ ₚ
  cz = - k0
  s : ℤ ₚ
  s = k0
  k' = k + k0
  pf' = k' , mc1 , mc0'
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • S ≈ CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • S ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • S ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • S ≈⟨ (cright t0 .proj₂ .proj₂) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S^ k0 • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S^ k0) • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ k0) ⟦ mc1 ⟧ₘ₊)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-CXS^k k0)) ⟩
    S^ k • (S^ k0 • S^ k0 ↑ • CZ^ (- k0) • H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 4 • □) (□ ^ 2 • □ ^ 4) auto ⟩
    (S^ k • S^ k0) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-S^k+l k k0) ⟩
    (S^ (k + k0)) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ sym assoc ⟩
    (S^ (k + k0) • S^ k0 ↑) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ (k + k0)) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ (k + k0)) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    S^ k0 ↑ • S^ (k + k0) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright sym assoc) ⟩
    S^ k0 ↑ • (S^ (k + k0) • CZ^ (- k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft word-comm (toℕ (k + k0)) (toℕ (- k0)) (sym (axiom comm-CZ-S↓))) ⟩
    S^ k0 ↑ • (CZ^ (- k0) • S^ (k + k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k0 ↑ • CZ^ (- k0)) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft sym (aux (- k0) k0)) ⟩
    (CZ^ (- k0) • S^ k0 ↑) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ ∎
    where
    aux : ∀ a b -> CZ^ a • S^ b ↑ ≈ S^ b ↑ • CZ^ a
    aux a b = begin
      CZ^ a • S^ b ↑ ≈⟨ (cright sym (refl' (aux-↑ S (toℕ b)))) ⟩
      CZ^ a • S ↑ ^ toℕ b ≈⟨ word-comm (toℕ a) (toℕ b) (axiom comm-CZ-S↑) ⟩
      S ↑ ^ toℕ b • CZ^ a ≈⟨ (cleft refl' (aux-↑ S (toℕ b))) ⟩
      S^ b ↑ • CZ^ a ∎

Lemma-Postfix-SingleQ pf@(k , mc1 , mc0) (H-gen ↥) sg = cz , s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-H {0} mc1
  k0 = t0 .proj₁
  mc1' = t0 .proj₂ .proj₁
  cz : ℤ ₚ
  cz = ₀
  s : ℤ ₚ
  s = k0
  pf' = k , mc1' , mc0
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ↑ ≈ CZ^ cz • S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ↑ ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ↑ ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ↑ ≈⟨ (cright aux-comm-mc-H↑ mc0) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • H ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • H ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft lemma-cong↑ _ _ (t0 .proj₂ .proj₂)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 ↑ • ⟦ mc1' ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0 ↑) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft aux-comm-CX-S^k↑ k0) ⟩
    S^ k • (S^ k0 ↑ • (H^ ₃ • CZ • H)) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k • S^ k0 ↑) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ k) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ k) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ • □) (□ • □ ^ 3) auto ⟩
    S^ k0 ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ≈⟨ sym left-unit ⟩
    CZ^ cz • S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ∎

Lemma-Postfix-SingleQ pf@(k , mc1 , mc0) (S-gen ↥) sg = cz , s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-S {0} mc1
  k0 = t0 .proj₁
  mc1' = t0 .proj₂ .proj₁
  cz : ℤ ₚ
  cz = ₀
  s : ℤ ₚ
  s = k0
  pf' = k , mc1' , mc0
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • S ↑ ≈ CZ^ cz • S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • S ↑ ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • S ↑ ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • S ↑ ≈⟨ (cright aux-comm-mc-S↑ mc0) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft lemma-cong↑ _ _ (t0 .proj₂ .proj₂)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 ↑ • ⟦ mc1' ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0 ↑) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft aux-comm-CX-S^k↑ k0) ⟩
    S^ k • (S^ k0 ↑ • (H^ ₃ • CZ • H)) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k • S^ k0 ↑) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ k) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ k) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ • □) (□ • □ ^ 3) auto ⟩
    S^ k0 ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ≈⟨ sym left-unit ⟩
    CZ^ cz • S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ∎



Lemma-Postfix-SingleQ-S↑ :

  ∀ (pf : Postfix) ->
  ---------------------------------------------------------------
  ∃ \ s -> ∃ \ pf' -> ⟦ pf ⟧ₚ • S ↑ ≈ S^ s ↑ • ⟦ pf' ⟧ₚ

Lemma-Postfix-SingleQ-S↑ pf@(k , mc1 , mc0) = s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-S {0} mc1
  k0 = t0 .proj₁
  mc1' = t0 .proj₂ .proj₁
  s : ℤ ₚ
  s = k0
  pf' = k , mc1' , mc0
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • S ↑ ≈ S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • S ↑ ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • S ↑ ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • S ↑ ≈⟨ (cright aux-comm-mc-S↑ mc0) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft lemma-cong↑ _ _ (t0 .proj₂ .proj₂)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 ↑ • ⟦ mc1' ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0 ↑) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft aux-comm-CX-S^k↑ k0) ⟩
    S^ k • (S^ k0 ↑ • (H^ ₃ • CZ • H)) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k • S^ k0 ↑) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ k) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ k) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ • □) (□ • □ ^ 3) auto ⟩
    S^ k0 ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ≈⟨ refl ⟩
    S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ∎



Lemma-Postfix-SingleQ-H↑ :

  ∀ (pf : Postfix) ->
  ---------------------------------------------------------------
  ∃ \ s -> ∃ \ pf' -> ⟦ pf ⟧ₚ • H ↑ ≈ S^ s ↑ • ⟦ pf' ⟧ₚ

Lemma-Postfix-SingleQ-H↑ pf@(k , mc1 , mc0) = s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-H {0} mc1
  k0 = t0 .proj₁
  mc1' = t0 .proj₂ .proj₁
  s : ℤ ₚ
  s = k0
  pf' = k , mc1' , mc0
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ↑ ≈ S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ↑ ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ↑ ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ↑ ≈⟨ (cright aux-comm-mc-H↑ mc0) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • H ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • H ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft lemma-cong↑ _ _ (t0 .proj₂ .proj₂)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 ↑ • ⟦ mc1' ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0 ↑) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cright cleft aux-comm-CX-S^k↑ k0) ⟩
    S^ k • (S^ k0 ↑ • (H^ ₃ • CZ • H)) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k • S^ k0 ↑) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ k) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ k) • (H^ ₃ • CZ • H) • ⟦ mc1' ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ • □) (□ • □ ^ 3) auto ⟩
    S^ k0 ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ≈⟨ refl ⟩
    S^ s ↑ • ⟦ k , mc1' , mc0 ⟧ₚ ∎


Lemma-Postfix-SingleQ-H :

  ∀ (pf : Postfix) ->
  ---------------------------------------------------------
  ∃ \ cz -> ∃ \ s -> ∃ \ pf' -> ⟦ pf ⟧ₚ • H ≈ CZ^ cz • S^ s ↑ • ⟦ pf' ⟧ₚ

Lemma-Postfix-SingleQ-H pf@(k , mc1 , mc0) = cz , s , pf' , claim
  where
  t0 = CP1.Lemma-single-qupit-completeness-mc-H {1} mc0
  k0 = t0 .proj₁
  mc0' = t0 .proj₂ .proj₁
  cz : ℤ ₚ
  cz = - k0
  s : ℤ ₚ
  s = k0
  k' = k + k0
  pf' = k' , mc1 , mc0'
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ≈ CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ≈⟨ (cright t0 .proj₂ .proj₂) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S^ k0 • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S^ k0) • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ k0) ⟦ mc1 ⟧ₘ₊)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-CXS^k k0)) ⟩
    S^ k • (S^ k0 • S^ k0 ↑ • CZ^ (- k0) • H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 4 • □) (□ ^ 2 • □ ^ 4) auto ⟩
    (S^ k • S^ k0) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-S^k+l k k0) ⟩
    (S^ (k + k0)) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ sym assoc ⟩
    (S^ (k + k0) • S^ k0 ↑) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ (k + k0)) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ (k + k0)) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    S^ k0 ↑ • S^ (k + k0) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright sym assoc) ⟩
    S^ k0 ↑ • (S^ (k + k0) • CZ^ (- k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft word-comm (toℕ (k + k0)) (toℕ (- k0)) (sym (axiom comm-CZ-S↓))) ⟩
    S^ k0 ↑ • (CZ^ (- k0) • S^ (k + k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k0 ↑ • CZ^ (- k0)) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft sym (aux (- k0) k0)) ⟩
    (CZ^ (- k0) • S^ k0 ↑) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ ∎
    where
    aux : ∀ a b -> CZ^ a • S^ b ↑ ≈ S^ b ↑ • CZ^ a
    aux a b = begin
      CZ^ a • S^ b ↑ ≈⟨ (cright sym (refl' (aux-↑ S (toℕ b)))) ⟩
      CZ^ a • S ↑ ^ toℕ b ≈⟨ word-comm (toℕ a) (toℕ b) (axiom comm-CZ-S↑) ⟩
      S ↑ ^ toℕ b • CZ^ a ≈⟨ (cleft refl' (aux-↑ S (toℕ b))) ⟩
      S^ b ↑ • CZ^ a ∎


Lemma-Postfix-SingleQ-S-ε :

  ∀ k pmc1 m -> let pf = (k , pmc1 , (m , ε)) in let cz = - m ^2 in
  ---------------------------------------------------------
  let s = m ^2 in let k' = k + s in ⟦ pf ⟧ₚ • S ≈ CZ^ cz • S^ s ↑ • ⟦ (k' , pmc1 , (m , ε)) ⟧ₚ

Lemma-Postfix-SingleQ-S-ε k mc1 m  = claim
  where
  cz : ℤ ₚ
  cz = - m ^2
  k0 = m ^2
  s : ℤ ₚ
  s = k0
  k' = k + k0
  mc0 = (m , ε)
  mc0' = (m , ε)
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • S ≈ CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • S ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • S ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • S ≈⟨ cright CP1.Lemma-single-qupit-completeness-mc-S-ε m ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S^ k0 • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S^ k0) • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ k0) ⟦ mc1 ⟧ₘ₊)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ k0 • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ k0) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-CXS^k k0)) ⟩
    S^ k • (S^ k0 • S^ k0 ↑ • CZ^ (- k0) • H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 4 • □) (□ ^ 2 • □ ^ 4) auto ⟩
    (S^ k • S^ k0) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-S^k+l k k0) ⟩
    (S^ (k + k0)) • S^ k0 ↑ • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ sym assoc ⟩
    (S^ (k + k0) • S^ k0 ↑) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ (k + k0)) (S^ k0)) ⟩
    (S^ k0 ↑ • S^ (k + k0)) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    S^ k0 ↑ • S^ (k + k0) • CZ^ (- k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright sym assoc) ⟩
    S^ k0 ↑ • (S^ (k + k0) • CZ^ (- k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft word-comm (toℕ (k + k0)) (toℕ (- k0)) (sym (axiom comm-CZ-S↓))) ⟩
    S^ k0 ↑ • (CZ^ (- k0) • S^ (k + k0)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ k0 ↑ • CZ^ (- k0)) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft sym (aux (- k0) k0)) ⟩
    (CZ^ (- k0) • S^ k0 ↑) • S^ (k + k0) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ ∎
    where
    aux : ∀ a b -> CZ^ a • S^ b ↑ ≈ S^ b ↑ • CZ^ a
    aux a b = begin
      CZ^ a • S^ b ↑ ≈⟨ (cright sym (refl' (aux-↑ S (toℕ b)))) ⟩
      CZ^ a • S ↑ ^ toℕ b ≈⟨ word-comm (toℕ a) (toℕ b) (axiom comm-CZ-S↑) ⟩
      S ↑ ^ toℕ b • CZ^ a ≈⟨ (cleft refl' (aux-↑ S (toℕ b))) ⟩
      S^ b ↑ • CZ^ a ∎


Lemma-Postfix-SingleQ-S-HS :

  ∀ k pmc1 m cc -> let pf = (k , pmc1 , (m , HS^ cc)) in 
  ---------------------------------------------------------
  ⟦ pf ⟧ₚ • S ≈ ⟦ (k , pmc1 , (m , HS^ (1ₚ + cc))) ⟧ₚ

Lemma-Postfix-SingleQ-S-HS k mc1 m cc  = claim
  where

  mc0 = (m , HS^ cc)
  mc0' = (m , HS^ (1ₚ + cc))
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • S ≈ ⟦ k , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • S ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • S ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • S ≈⟨ cright CP1.Lemma-single-qupit-completeness-mc-S-HS m cc ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □) (□ ^ 4) auto ⟩
    ⟦ k , mc1 , mc0' ⟧ₚ ∎




Lemma-Postfix-SingleQ-H-ε :

  ∀ k pmc1 m -> let pf = (k , pmc1 , (m , ε)) in 
  ---------------------------------------------------------
  ⟦ pf ⟧ₚ • H ≈ ⟦ (k , pmc1 , (m , HS^ ₀)) ⟧ₚ

Lemma-Postfix-SingleQ-H-ε k mc1 m  = claim
  where

  mc0 = (m , ε)
  mc0' = (m , HS^ ₀)
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ≈ ⟦ k , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ≈⟨ cright CP1.Lemma-single-qupit-completeness-mc-H-ε m ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □) (□ ^ 4) auto ⟩
    ⟦ k , mc1 , mc0' ⟧ₚ ∎

Lemma-Postfix-SingleQ-H-HS⁰ :

  ∀ k pmc1 m -> let pf = (k , pmc1 , (m , HS^ ₀)) in let mc' = (m *' -'₁ , ε) in 
  ---------------------------------------------------------
  ⟦ pf ⟧ₚ • H ≈ ⟦ (k , pmc1 , mc') ⟧ₚ

Lemma-Postfix-SingleQ-H-HS⁰ k mc1 m  = claim
  where

  mc0 = (m , HS^ ₀)
  mc0' = (m *' -'₁ , ε)
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ≈ ⟦ k , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ≈⟨ cright CP1.Lemma-single-qupit-completeness-mc-H-HS⁰ m ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □) (□ ^ 4) auto ⟩
    ⟦ k , mc1 , mc0' ⟧ₚ ∎



Lemma-Postfix-SingleQ-H-HS :

  ∀ k mc1 m kk* -> let pf = (k , mc1 , (m , HS^ (kk* .proj₁))) in 
  ---------------------------------------------------------
  let k* = (-' (kk* ⁻¹) *' (m *' m)) in
  let sk = k* .proj₁ in
  let -m/kk* = ((m *' kk* ⁻¹) *' -'₁) in
  let -1/kk = - (kk* ⁻¹) .proj₁ in
  let mc' = (-m/kk* , HS^ -1/kk) in
  ---------------------------------------------------------
  let cz = - sk in let s = sk in  let pf' = (k + s , mc1 , mc') in ⟦ pf ⟧ₚ • H ≈ CZ^ cz • S^ s ↑ • ⟦ pf' ⟧ₚ

Lemma-Postfix-SingleQ-H-HS k mc1 m kk* = claim
  where
  k* = (-' (kk* ⁻¹) *' (m *' m))
  sk = k* .proj₁
  -m/kk* = ((m *' kk* ⁻¹) *' -'₁)
  -1/kk = - (kk* ⁻¹) .proj₁
  mc' = (-m/kk* , HS^ -1/kk)

  mc0' = mc'
  cz : ℤ ₚ
  cz = - sk
  s : ℤ ₚ
  s = sk
  k0 = s
  k' = k + s
  mc0 = (m , HS^ (kk* .proj₁))
  pf' = k' , mc1 , mc0'
  claim : ⟦ k , mc1 , mc0 ⟧ₚ • H ≈ CZ^ cz • S^ s ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ
  claim = begin
    ⟦ k , mc1 , mc0 ⟧ₚ • H ≈⟨ refl ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0 ⟧ₘ₊) • H ≈⟨ special-assoc (□ ^ 4 • □) (□ ^ 3 • □ ^ 2) auto ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0 ⟧ₘ₊ • H ≈⟨ (cright CP1.Lemma-single-qupit-completeness-mc-H-HS m kk*) ⟩
    (S^ k • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑) • S^ sk • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 3 • □ ^ 2) (□ ^ 2 • □ ^ 2 • □) auto ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (⟦ mc1 ⟧ₘ₊ ↑ • S^ sk) • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-comm-Sᵏ-w↑ (toℕ sk) ⟦ mc1 ⟧ₘ₊)) ⟩
    (S^ k • (H^ ₃ • CZ • H)) • (S^ sk • ⟦ mc1 ⟧ₘ₊ ↑) • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ ^ 2 • □ ^ 2 • □) (□ • □ ^ 2 • □ ^ 2) auto ⟩
    S^ k • ((H^ ₃ • CZ • H) • S^ sk) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft sym (lemma-CXS^k sk)) ⟩
    S^ k • (S^ sk • S^ sk ↑ • CZ^ (- sk) • H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 4 • □) (□ ^ 2 • □ ^ 4) auto ⟩
    (S^ k • S^ sk) • S^ sk ↑ • CZ^ (- sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-S^k+l k sk) ⟩
    (S^ (k + sk)) • S^ sk ↑ • CZ^ (- sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ sym assoc ⟩
    (S^ (k + sk) • S^ sk ↑) • CZ^ (- sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft lemma-comm-Sᵏ-w↑ (toℕ (k + sk)) (S^ sk)) ⟩
    (S^ sk ↑ • S^ (k + sk)) • CZ^ (- sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    S^ sk ↑ • S^ (k + sk) • CZ^ (- sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright sym assoc) ⟩
    S^ sk ↑ • (S^ (k + sk) • CZ^ (- sk)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cright cleft word-comm (toℕ (k + sk)) (toℕ (- sk)) (sym (axiom comm-CZ-S↓))) ⟩
    S^ sk ↑ • (CZ^ (- sk) • S^ (k + sk)) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ special-assoc (□ • □ ^ 2 • □) (□ ^ 2 • □ • □) auto ⟩
    (S^ sk ↑ • CZ^ (- sk)) • S^ (k + sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ (cleft sym (aux (- sk) sk)) ⟩
    (CZ^ (- sk) • S^ sk ↑) • S^ (k + sk) • (H^ ₃ • CZ • H) • ⟦ mc1 ⟧ₘ₊ ↑ • ⟦ mc0' ⟧ₘ₊ ≈⟨ assoc ⟩
    CZ^ cz • S^ sk ↑ • ⟦ k' , mc1 , mc0' ⟧ₚ ∎
    where
    aux : ∀ a b -> CZ^ a • S^ b ↑ ≈ S^ b ↑ • CZ^ a
    aux a b = begin
      CZ^ a • S^ b ↑ ≈⟨ (cright sym (refl' (aux-↑ S (toℕ b)))) ⟩
      CZ^ a • S ↑ ^ toℕ b ≈⟨ word-comm (toℕ a) (toℕ b) (axiom comm-CZ-S↑) ⟩
      S ↑ ^ toℕ b • CZ^ a ≈⟨ (cleft refl' (aux-↑ S (toℕ b))) ⟩
      S^ b ↑ • CZ^ a ∎
